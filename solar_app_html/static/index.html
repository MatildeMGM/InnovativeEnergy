<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PV Map (Local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #side { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; cursor: crosshair; }

    .row { margin-bottom: 10px; }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input, select { width: 100%; padding: 6px; box-sizing: border-box; }
    button { padding: 10px; width: 100%; margin-bottom: 8px; }
    pre { background: #dddddd; padding: 10px; white-space: pre-wrap; }

    .small { font-size: 12px; color: #555; }
    .hr { height: 1px; background: #dddddd; margin: 10px 0; }
    #plans { font-size: 13px; }
    .planItem {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 8px 0;
      background: #fff;
      overflow: hidden;
    }
    .planItem summary {
      cursor: pointer;
      padding: 10px;
      background: #f7f7f7;
      font-weight: 600;
      outline: none;
    }
    .planBody {
      padding: 10px;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
    }
    .kv .k { color: #555; font-size: 12px; }
    .kv .v { color: #111; word-break: break-word; }
    .kv a { color: #0b57d0; text-decoration: none; }
    .kv a:hover { text-decoration: underline; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      margin-left: 8px;
    }

    #summary { font-size: 13px; }

    .section {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 8px 0;
      overflow: visible;
      background: #fff;
    }

    .section summary {
      cursor: pointer;
      padding: 10px;
      background: #f7f7f7;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section .body { padding: 10px; }

    .warnPill{
      display:inline-block;
      padding:2px 8px;
      margin-left:6px;
      border-radius:999px;
      background:#fff3cd;
      color:#7a5c00;
      font-size:12px;
      font-weight:600;
    }

    .row2 {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 6px 10px;
      align-items: start;
    }
    .row2 .k { color: #555; font-size: 12px; }
    .row2 .v { color: #111; word-break: break-word; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .detailSection{
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      background: #fafafa;
    }

    .detailTitle{
      font-weight: 700;
      margin-bottom: 8px;
    }

    .detailRow{
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      padding: 6px 0;
      border-top: 1px solid #eee;
    }

    .detailRow:first-child{ border-top: none; }

    .detailLabel{
      font-size: 12px;
      color: #555;
    }

    .detailValue{
      font-size: 13px;
      color: #111;
      white-space: pre-wrap;
      line-height: 1.35;
    }


    /* Tooltip */
    .qm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid #bbb;
      font-size: 11px;
      color: #555;
      margin-left: 6px;
      cursor: help;
      position: relative;
      user-select: none;
    }

    .qm::after {
      content: attr(data-tip);
      position: absolute;
      left: 0px;
      top: 22px;
      min-width: 220px;
      max-width: 320px;
      white-space: normal;
      background: #111;
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.3;
      opacity: 0;
      pointer-events: none;
      transform: translateY(4px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 9999;
    }

    .qm:hover::after {
      opacity: 1;
      transform: translateY(0);
    }

    /* Geocoder search box styling */
    .leaflet-control-geocoder {
      width: 260px !important;
    }

    .leaflet-control-geocoder input {
      width: 100% !important;
      height: 36px;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 8px;
    }

    /* softer placeholder look */
    .leaflet-control-geocoder input::placeholder {
      color: #666;
      opacity: 0.6;
    }

    .leaflet-control-geocoder-icon {
      display: none;
    }




  </style>
</head>

<body>
<div id="wrap">
  <div id="side">
    <h1>PV estimator</h1>

    <div class="row">
      <label>Preset</label>
      <select id="preset"></select>
    </div>

    <div class="row">
      <label>PV size (kWp)</label>
      <input id="kwp" type="number" step="0.1" value="1.0" min="0">
    </div>

    <div class="row">
      <label>Performance ratio PR (optional)</label>
      <input id="pr" type="number" step="0.01" value="1.00" min="0" max="1.2">
    </div>

    <div class="row">
      <label>Tilt (°)</label>
      <input id="tilt" type="number" step="1" value="40">
    </div>

    <div class="row">
      <label>Azimuth (°)</label>
      <input id="az" type="number" step="1" value="180">
    </div>

    <div class="row">
      <label>Day</label>
      <input id="day" type="date">
    </div>

    <div class="row">
      <label>24h resolution</label>
      <select id="freq">
        <option value="1h">Hourly</option>
        <option value="15min">15 min</option>
        <option value="5min">5 min</option>
      </select>
    </div>

    <button id="btnSummary">Refresh summary</button>
    <button id="btnPlots">Show plots</button>

    <div class="hr"></div>

    <div class="small"><b>Status:</b> <span id="status">Click map to set location. Use Refresh summary / Show plots afterwards.</span></div>
    <div class="small"><b>Selected:</b> <span id="coord">—</span></div>

    <div id="summary">No summary yet.</div>

    <div class="hr"></div>
    <h4 style="margin: 8px 0;">Plans</h4>
    <div id="plans">No plans yet.</div>

    <canvas id="chartDay" height="140"></canvas>
    <canvas id="chartYear" height="140"></canvas>
  </div>

  <div id="map"></div>
</div>

<script>
  const summaryEl = document.getElementById("summary");
  const plansEl = document.getElementById("plans");
  const coord = document.getElementById("coord");
  const statusEl = document.getElementById("status");

  const presetEl = document.getElementById("preset");
  const kwpEl = document.getElementById("kwp");
  const prEl = document.getElementById("pr");
  const tiltEl = document.getElementById("tilt");
  const azEl = document.getElementById("az");
  const dayEl = document.getElementById("day");
  const freqEl = document.getElementById("freq");

  let PRESETS = {};
  let selected = null;
  let marker = null;

  let chartDay = null;
  let chartYear = null;
  let lastSummary = null;

  async function getJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  function setSelected(lat, lon) {
    selected = {lat, lon};
    coord.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    statusEl.textContent = "Location set. Use Refresh summary / Show plots afterwards.";

    if (marker) {
      marker.setLatLng([lat, lon]);
    }
  }

  function applyPreset(name) {
    const kwp = PRESETS[name];

    if (name !== "Custom") {
      kwpEl.value = kwp;
      kwpEl.disabled = true;
    } else {
      kwpEl.disabled = false;
    }
  }

  function tip(text) {
    return `<span class="qm" data-tip="${escapeAttr(text)}">?</span>`;
  }

  function renderSummary(data) {
    const s = data.inputs;

    const locationStr = `${data.location.lat.toFixed(5)}, ${data.location.lon.toFixed(5)}`;
    const settingsStr = `kWp=${Number(s.kwp).toFixed(2)}, PR=${Number(s.pr).toFixed(2)}, tilt=${Number(s.tilt).toFixed(0)}°, az=${Number(s.az).toFixed(0)}°`;

    const peakPoa = Math.round(data.peak_poa_wm2);
    const peakPower = Math.round(data.peak_power_w);

    const dayKwh = data.energy_day_kwh_clear_sky.toFixed(2);
    const yearKwh = Math.round(data.energy_year_kwh_tmy);

    const html = `
      <details class="section">
        <summary>
          PV results
          <span class="badge">${yearKwh} kWh/yr</span>
        </summary>

        <div class="body">

          <details class="section" open>
            <summary>Overview</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Location ${tip("Latitude/longitude of the clicked point on the map.")}</div>
                <div class="v">${escapeHtml(locationStr)}</div>

                <div class="k">Settings ${tip("kWp is the PV system rated power at STC. PR is a loss factor (1.00 = no losses). Tilt/azimuth define panel orientation.")}</div>
                <div class="v">${escapeHtml(settingsStr)}</div>

                <div class="k">Selected day</div>
                <div class="v">${escapeHtml(s.day)} (step=${escapeHtml(s.freq)})</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Peak values</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Peak POA</div>
                <div class="v">${peakPoa} W/m²</div>

                <div class="k">Peak PV power</div>
                <div class="v">${peakPower} W</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Energy results</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Clear-sky day</div>
                <div class="v">${dayKwh} kWh</div>

                <div class="k">Year total (TMY/PVGIS)</div>
                <div class="v">${yearKwh} kWh (year ${escapeHtml(String(data.year))})</div>
              </div>
            </div>
          </details>

        </div>
      </details>
    `;


    summaryEl.innerHTML = html;

    // keep your plans rendering call:
    renderPlans(data.plan);
  }


  function renderPlots(data) {
    const day = data.series_day;
    const year = data.series_year;

    if (chartDay) chartDay.destroy();
    if (chartYear) chartYear.destroy();

    chartDay = new Chart(document.getElementById("chartDay"), {
      type: "line",
      data: {
        labels: day.t,
        datasets: [{ label: "Power (W)", data: day.power_w, pointRadius: 0 }]
      },
      options: { responsive: true, scales: { x: { display: false } } }
    });

    chartYear = new Chart(document.getElementById("chartYear"), {
      type: "line",
      data: {
        labels: year.d,
        datasets: [{ label: "Daily energy (kWh/day)", data: year.kwh, pointRadius: 0 }]
      },
      options: { responsive: true, scales: { x: { display: false } } }
    });
  }

  function isUrl(s) {
    return typeof s === "string" && (s.startsWith("http://") || s.startsWith("https://"));
  }

  function niceLabel(key) {
    // Optional: rename keys to nicer labels
    const map = {
      plannavn: "Plan name",
      planid: "Plan ID",
      plantype: "Plan type",
      status: "Status",
      doklink: "Document",
      link: "Link",
      url: "URL",
      doklink: "Document"
    };
    return map[key] || key;
  }

  function isEmptyVal(v) {
    return v === null || v === undefined || String(v).trim() === "";
  }

  function renderDetailSection(title, items) {
    const rows = items
      .filter(it => !isEmptyVal(it.value))
      .map(it => `
        <div class="detailRow">
          <div class="detailLabel">${escapeHtml(it.label)}</div>
          <div class="detailValue">${escapeHtml(String(it.value))}</div>
        </div>
      `)
      .join("");

    if (!rows) return "";

    return `
      <div class="detailSection">
        <div class="detailTitle">${escapeHtml(title)}</div>
        <div class="detailBody">${rows}</div>
      </div>
    `;
  }

  function renderDetails(details) {
    if (!details || !Array.isArray(details) || details.length === 0) {
      return "<div class='small'>No extra details.</div>";
    }

    const d = details[0];

    const sol = renderDetailSection("Sol", [
      { label: "Side", value: d.sol_side },
      { label: "Paragraf", value: d.sol_paragraf },
      { label: "Kommentar", value: d.kommentar_sol },
    ]);

    const vind = renderDetailSection("Vind", [
      { label: "Side", value: d.vind_side },
      { label: "Paragraf", value: d.vind_paragraf },
      { label: "Kommentar", value: d.kommentar_vind },
    ]);

    const batteri = renderDetailSection("Batteri", [
      { label: "Side", value: d.batteri_side },
      { label: "Paragraf", value: d.batteri_paragraf },
      { label: "Kommentar", value: d.kommentar_batteri },
    ]);

    const tekniske = renderDetailSection("Tekniske anlæg", [
      { label: "Side", value: d.tekniske_anlaeg_side },
      { label: "Paragraf", value: d.tekniske_anlaeg_paragraf },
      { label: "Kommentar", value: d.kommentar_tekniske_anlaeg },
    ]);

    const andet = renderDetailSection("Andet relevant regulering", [
      { label: "Side", value: d.andet_side },
      { label: "Paragraf", value: d.andet_paragraf },
      { label: "Kommentar", value: d.kommentar_andet_regulering },
    ]);

    const kort = renderDetailSection("Kort kommentar", [
      { label: "Kommentar", value: d.kommentar_kort },
    ]);

    const html = [sol, vind, batteri, tekniske, andet, kort].filter(Boolean).join("");

    return html || "<div class='small'>No relevant fields found in details.</div>";
  }


  function renderPlans(plans) {
    if (!plansEl) return;

    if (!plans || plans.length === 0) {
      plansEl.innerHTML = "<div class='small'>No plans found at clicked location.</div>";
      return;
    }

    const parts = [];
    parts.push(`<div class="small"><b>Found:</b> ${plans.length}</div>`);

    plans.forEach((p, idx) => {
      const name = p.plannavn || p.plan_navn || p.navn || `Plan ${idx + 1}`;
      const id = p.planid ? String(p.planid) : "";
      const status = p.status ? String(p.status) : "";
      const det = p.details?.[0] || {};

      function warn(flag, label){
        return flag ? `<span class="warnPill">⚠ ${label}</span>` : "";
      }

      const warnings = [
        warn(det.sol_relevant, "Sol"),
        warn(det.vind_relevant, "Vind"),
        warn(det.batteri_relevant, "Batteri"),
        warn(det.tekniske_anlaeg_relevant, "Teknik"),
        warn(det.andet_relevant_regulering, "Andet"),
      ].join("");

      // Her kan der udføres visuelle ændringer for plan-interface på HTML
      parts.push(`
        <details class="planItem">
          <summary>
            ${escapeHtml(name)}
            ${id ? `<span class="pill">ID: ${escapeHtml(id)}</span>` : ""}
            ${warnings}
          </summary>
          <div class="planBody">
            <div class="kv">
              ${Object.entries(p).map(([k, v]) => {
                if (v === null || v === undefined || v === "") return "";
                const keyLabel = niceLabel(k);

                // ✅ Special rendering for details (array of objects)
                if (k === "details") {
                  return `<div style="grid-column: 1 / -1;">${renderDetails(v)}</div>`;
                }

                const valStr = String(v);

                if (isUrl(valStr)) {
                  return `<div class="k">${escapeHtml(keyLabel)}</div>
                          <div class="v"><a href="${escapeAttr(valStr)}" target="_blank" rel="noopener noreferrer">Open document</a></div>`;
                }

                return `<div class="k">${escapeHtml(keyLabel)}</div>
                        <div class="v">${escapeHtml(valStr)}</div>`;
              }).join("")}
            </div>
          </div>
        </details>
      `);
    });

    plansEl.innerHTML = parts.join("");
  }

  // Basic escaping to avoid breaking HTML if plan fields contain odd characters
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function escapeAttr(s) {
    // For href attributes
    return escapeHtml(s);
  }


  async function init() {
    // Default date = today
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, "0");
    const dd = String(today.getDate()).padStart(2, "0");
    dayEl.value = `${yyyy}-${mm}-${dd}`;

    const presetsResp = await getJSON("/api/presets");
    PRESETS = presetsResp.presets;

    presetEl.innerHTML = "";
    for (const name of Object.keys(PRESETS)) {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      presetEl.appendChild(opt);
    }
    presetEl.value = "1 kWp";
    applyPreset(presetEl.value);

    presetEl.addEventListener("change", () => applyPreset(presetEl.value));

    const center = await getJSON("/api/center");

    // Map
    const map = L.map("map").setView([center.lat, center.lon], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      minZoom: 10,
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Marker visible immediately (like original)
    marker = L.marker([center.lat, center.lon]).addTo(map);
    setSelected(center.lat, center.lon);

    // Bornholm layer
    const bornholm = await getJSON("/api/bornholm");
    const bornholmLayer = L.geoJSON(bornholm, {
      style: { weight: 2, fillOpacity: 0.05 },
      onEachFeature: (feature, layer) => {
        layer.on("click", (e) => {
          setSelected(e.latlng.lat, e.latlng.lng);
        });
      }
    });
    

    // Planer layer (full, like original)
    const planer = await getJSON("/api/planer");
    const planerLayer = L.geoJSON(planer, {
      style: { weight: 1, fillOpacity: 0.10 },
      onEachFeature: (feature, layer) => {
        // IMPORTANT: clicking polygons should still select location
        layer.on("click", (e) => {
          setSelected(e.latlng.lat, e.latlng.lng);
        });
      }
    });

    bornholmLayer.addTo(map);
    planerLayer.addTo(map);
    
    const bounds = bornholmLayer.getBounds();
    map.fitBounds(bounds.pad(0.15));
    map.setMaxBounds(bounds.pad(0.25));

    L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: "Indtast adresse",
      collapsed: false
    })
    .on('markgeocode', function(e) {
      const latlng = e.geocode.center;

      setSelected(latlng.lat, latlng.lng);  // your existing function
      map.setView(latlng, 15);

      if (marker) marker.setLatLng(latlng);
    })
    .addTo(map);

    // Layer control like original
    L.control.layers(
      { "OpenStreetMap": L.tileLayer },
      { "Bornholm": bornholmLayer, "Lokal Planer": planerLayer },
      { collapsed: false }
    );

    // Map click (works everywhere not caught by polygons)
    map.on("click", (e) => {
      setSelected(e.latlng.lat, e.latlng.lng);
    });


    // Buttons
    document.getElementById("btnSummary").onclick = async () => {
      if (!selected) {
        statusEl.textContent = "Click map to set location first.";
        return;
      }

      statusEl.textContent = "Computing summary…";

      const params = new URLSearchParams({
        lat: selected.lat,
        lon: selected.lon,
        kwp: kwpEl.value,
        pr: prEl.value,
        tilt: tiltEl.value,
        az: azEl.value,
        day: dayEl.value,
        freq: freqEl.value,
      });

      const data = await getJSON(`/api/summary?${params.toString()}`);
      lastSummary = data;
      renderSummary(data);
      statusEl.textContent = "Summary updated.";
    };

    document.getElementById("btnPlots").onclick = () => {
      if (!lastSummary) {
        statusEl.textContent = "Refresh summary first (so plot data exists).";
        return;
      }
      renderPlots(lastSummary);
      statusEl.textContent = "Plots updated.";
    };
  }

  init().catch(err => {
    summaryEl.textContent = "Init error:\n" + err;
    statusEl.textContent = "Error during initialization. See details in output box.";
    console.error(err);
  });
</script>
</body>
</html>
