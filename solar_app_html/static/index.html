<!-- index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Energi Borhnolm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #side { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; cursor: crosshair; }
    #bevaringskodeBox {
      font-size: 13px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      margin: 8px 0;
    }

    .row { margin-bottom: 10px; }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input, select { width: 100%; padding: 6px; box-sizing: border-box; }
    pre { background: #dddddd; padding: 10px; white-space: pre-wrap; }

    .small { font-size: 12px; color: #555; }
    .hr { height: 1px; background: #dddddd; margin: 10px 0; }
    #plans { font-size: 13px; }
    .planItem {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 8px 0;
      background: #fff;
      overflow: hidden;
    }
    .planItem summary {
      cursor: pointer;
      padding: 10px;
      background: #f7f7f7;
      font-weight: 600;
      outline: none;
    }
    .planBody {
      padding: 10px;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
    }
    .kv .k { color: #555; font-size: 12px; }
    .kv .v { color: #111; word-break: break-word; }
    .kv a { color: #0b57d0; text-decoration: none; }
    .kv a:hover { text-decoration: underline; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      margin-left: 8px;
    }

    #summary { font-size: 13px; }

    .section {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 8px 0;
      overflow: visible;
      background: #fff;
    }

    .section summary {
      cursor: pointer;
      padding: 10px;
      background: #f7f7f7;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section .body { padding: 10px; }

    .warnPill{
      display:inline-block;
      padding:2px 8px;
      margin-left:6px;
      border-radius:999px;
      background:#fff3cd;
      color:#7a5c00;
      font-size:12px;
      font-weight:600;
    }

    .row2 {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 6px 10px;
      align-items: start;
    }
    .row2 .k { color: #555; font-size: 12px; }
    .row2 .v { color: #111; word-break: break-word; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .detailSection{
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      background: #fafafa;
    }

    .detailTitle{
      font-weight: 700;
      margin-bottom: 8px;
    }

    .detailRow{
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      padding: 6px 0;
      border-top: 1px solid #eee;
    }

    .detailRow:first-child{ border-top: none; }

    .detailLabel{
      font-size: 12px;
      color: #555;
    }

    .detailValue{
      font-size: 13px;
      color: #111;
      white-space: pre-wrap;
      line-height: 1.35;
    }

    /* ===== Base Button Style ===== */
    .btn-main {
      width: 100%;
      padding: 14px 16px;
      font-size: 15px;
      font-weight: 700;
      border-radius: 12px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 10px;
    }

    .btn-main:hover {
      transform: translateY(-1px);
    }

    .btn-main:active {
      transform: translateY(0);
    }

    .btn-update {
      background: #2f6fed;
      border-color: #2f6fed;
      color: #ffffff;
    }

    .btn-update:hover {
      background: #255bd6;
    }

    .btn-overview {
      background: #e8f0ff;
      border-color: #2f6fed;
      color: #1f3f8f;
    }

    .btn-overview:hover {
      background: #d7e5ff;
    }

    /* Disabled state */
    .btn-main:disabled,
    .btn-main[disabled]{
      opacity: 0.45;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Loading state (button) */
    .btn-loading{
      position: relative;
      pointer-events: none; /* prevent double click */
      opacity: 0.9;
    }

    /* Subtle pulse while loading */
    .btn-loading{
      animation: btnPulse 1.1s ease-in-out infinite;
    }

    @keyframes btnPulse{
      0%   { filter: brightness(1); }
      50%  { filter: brightness(0.92); }
      100% { filter: brightness(1); }
    }

    /* Spinner */
    .btn-spinner{
      display: inline-block;
      width: 14px;
      height: 14px;
      margin-right: 10px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.55);
      border-top-color: rgba(255,255,255,1);
      animation: spin 0.8s linear infinite;
      vertical-align: -2px;
    }

    @keyframes spin{
      to { transform: rotate(360deg); }
    }

    /* If you use spinner inside the LIGHT blue button, swap to dark spinner */
    .btn-overview.btn-loading .btn-spinner,
    .btn-overview .btn-spinner{
      border-color: rgba(31,63,143,0.35);
      border-top-color: rgba(31,63,143,1);
    }


    /* Guide button (bigger, softer look) */
    .btn-guide {
      width: 100%;
      padding: 14px 16px;         /* larger than normal */
      font-size: 15px;            /* slightly larger text */
      font-weight: 700;
      border-radius: 12px;
      border: 2px solid #8db87c;
      background: #f4faef;        /* very light green background */
      color: #2f5f2f;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-guide:hover {
      background: #e4f3db;
      transform: translateY(-1px);
    }

    .btn-guide:active {
      transform: translateY(0);
    }

    /* Tooltip */
    .qm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid #bbb;
      font-size: 11px;
      color: #555;
      margin-left: 6px;
      cursor: help;
      position: relative;
      user-select: none;
    }

    .qm:hover::after {
      opacity: 1;
      transform: translateY(0);
    }

    /* Geocoder search box styling */
    .leaflet-control-geocoder {
      width: 260px !important;
    }

    .leaflet-control-geocoder input {
      width: 100% !important;
      height: 36px;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 8px;
    }

    /* softer placeholder look */
    .leaflet-control-geocoder input::placeholder {
      color: #666;
      opacity: 0.6;
    }

    .leaflet-control-geocoder-icon {
      display: none;
    }

    /* --- Layers control styling --- */
    .leaflet-control-layers {
      border-radius: 10px;
      overflow: hidden;
    }

    /* Title row inside the control */
    .layers-title {
      font-weight: 700;
      padding: 8px 10px;
      background: #f7f7f7;
      border-bottom: 1px solid #e6e6e6;
    }

    /* Make each overlay line a clean 3-column row: toggle | name | swatch */
    .leaflet-control-layers-overlays label {
      display: grid;
      grid-template-columns: 18px 1fr 18px;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin: 0;
      line-height: 1.2;
    }

    /* Keep checkbox aligned and not stretched */
    .leaflet-control-layers-overlays input[type="checkbox"] {
      margin: 0;
      justify-self: start;
    }

    /* Ensure the name doesn't collide with swatch */
    .leaflet-control-layers-overlays label .layer-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Put swatch on the right */
    .layer-swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 2px solid #666;
      margin: 0;
      justify-self: end;
    }

    /* Modal */    
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .modalCard {
      width: min(1100px, 96vw);
      max-height: 92vh;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
    }
    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f7f7f7;
      border-bottom: 1px solid #e6e6e6;
    }
    .modalClose {
      padding: 8px 10px;
      width: auto;
      margin: 0;
    }
    .modalBody {
      padding: 12px;
      overflow: auto;
    }
    .modalGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .modalPanel {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }

    /* ===== Guide modal layout ===== */
    .guideDoc{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 900px){
      .guideDoc{ grid-template-columns: 1fr; }
    }

    .guideSteps{
      display: grid;
      gap: 10px;
    }

    .guideStep{
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
    }

    .guideStepTitle{
      font-weight: 800;
      margin-bottom: 6px;
    }

    .guideStepText{
      font-size: 13px;
      color: #111;
      line-height: 1.4;
    }

    .guideImgGrid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .guideFigure{
      margin: 0;
    }

    .imgPlaceholder{
      width: 100%;
      height: 160px;
      border-radius: 10px;
      border: 2px dashed #ccc;
      background: #f7f7f7;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #666;
      font-weight: 700;
      line-height: 1.3;
    }

    /* Print guide modal only */
    @media print{
      body.print-guide #side,
      body.print-guide #map{
        display: none !important;
      }

      body.print-guide #wrap{
        display: block !important;
        height: auto !important;
      }

      body.print-guide #guideModal{
        display: block !important;
        position: static !important;
        inset: auto !important;
        background: none !important;
      }

      body.print-guide .modalCard{
        width: 100% !important;
        max-height: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      body.print-guide .modalBody{
        overflow: visible !important;
      }

      body.print-guide .modalClose{
        display: none !important;
      }
    }

    /* Make Chart.js canvases always have a real height */
    #chartMonthlyEnergy,
    #chartMonthlyCost {
      width: 100% !important;
      height: 260px !important; /* adjust if you want taller/shorter */
    }

    /* In print, FORCE charts to stay side-by-side */
    @media print {
      body.print-modal .modalGrid {
        grid-template-columns: 1fr 1fr !important;
        gap: 12px !important;
      }

      /* keep the canvases height in print too */
      body.print-modal #chartMonthlyEnergy,
      body.print-modal #chartMonthlyCost {
        height: 260px !important;
      }
    }

    /* ===== Modal document layout ===== */
    .overviewDoc{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* Force overviewDoc to stack (econ first, PV after) */
    .overviewDoc.stack {
      grid-template-columns: 1fr;
    }

    /* Nice “document card” look */
    .docCard{
      border: 1px solid #ddd;
      border-radius: 10px;
      background: #fff;
      padding: 10px;
    }

    .docTitle{
      font-weight: 800;
      margin: 0 0 8px 0;
    }

    .docMeta{
      font-size: 12px;
      color: #555;
      margin-bottom: 10px;
    }

    .kvDoc{
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 6px 10px;
      font-size: 13px;
    }
    .kvDoc .k{ color:#555; font-size:12px; }
    .kvDoc .v{ color:#111; }

    @media (max-width: 900px) {
      .overviewDoc{ grid-template-columns: 1fr; }
    }

    /* Print: make sure the two columns still look good */
    @media print {
      body.print-modal .overviewDoc{
        grid-template-columns: 1fr 1fr;
      }
    }

    @media print {
      body.print-modal #overviewPlansSection{
        break-before: page;
        page-break-before: always;
      }
    }

    /* ===== Print modal only ===== */
    @media print {
      /* Keep wrap (it contains the modal), but remove sidebar + map */
      body.print-modal #side,
      body.print-modal #map {
        display: none !important;
      }

      /* Make wrap a normal block so the modal can flow */
      body.print-modal #wrap {
        display: block !important;
        height: auto !important;
      }

      /* Force modal visible (overrides inline style="display:none") */
      body.print-modal #monthlyModal {
        display: block !important;
        position: static !important;
        inset: auto !important;
        background: none !important;
      }



      body.print-modal .modalCard {
        width: 100% !important;
        max-height: none !important;
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      body.print-modal .modalBody {
        overflow: visible !important;
      }

      /* optional: hide buttons on paper */
      body.print-modal .modalClose {
        display: none !important;
      }
    }

    /* ===== Plans document layout in modal ===== */
    .plansDocGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* A “section header” inside doc cards */
    .docSectionTitle{
      font-weight: 800;
      margin: 0 0 8px 0;
    }

    /* Clean list formatting */
    .docList{
      margin: 0;
      padding-left: 16px;
    }
    .docList li{
      margin: 6px 0;
    }

    /* Link look (screen) */
    .docCard a{
      color: #0b57d0;
      text-decoration: none;
    }
    .docCard a:hover{
      text-decoration: underline;
    }

    /* Simple “plan box” for each found plan */
    .planDocItem{
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
      margin-top: 10px;
    }
    .planDocName{
      font-weight: 800;
      margin-bottom: 6px;
    }
    .planDocMeta{
      font-size: 12px;
      color: #555;
      margin-bottom: 8px;
    }

    /* Mobile: stack */
    @media (max-width: 900px) {
      .plansDocGrid{ grid-template-columns: 1fr; }
    }

    /* ===== Print: keep columns + make URLs visible and links clickable ===== */
    @media print {
      body.print-modal .plansDocGrid{
        grid-template-columns: 1fr 1fr;
      }

      /* Make sure links are underlined in print */
      .docCard a{
        color: #000 !important;
        text-decoration: underline !important;
      }

      /* Show the URL text so the PDF contains it (still clickable in most browsers) */
      .docCard a[href]::after{
        content: " (" attr(href) ")";
        font-size: 10px;
        color: #444;
        word-break: break-all;
      }
    }

    /* ===== Mini map inside “Samlet oversigt” ===== */
    .miniMapWrap{
      margin: 10px 0 12px 0;
      padding: 10px;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      background: #fafafa;
    }

    .miniMapTitle{
      font-weight: 800;
      font-size: 12px;
      margin-bottom: 8px;
      color: #111;
    }

    #miniMap{
      width: 100%;
      height: 220px;            /* <- change this to resize */
      border-radius: 12px;
      border: 1px solid #ddd;
      overflow: hidden;
    }

    .miniMapNote{
      margin-top: 6px;
    }

    /* ===== Fix Leaflet layers control being affected by global form styles ===== */
    .leaflet-control-layers input,
    .leaflet-control-layers select {
      width: auto !important;
      padding: 0 !important;
      box-sizing: content-box !important;
    }

    .leaflet-control-layers label {
      margin-bottom: 0 !important; /* your global label rule adds spacing */
    }

    /* Base layers: spacing between radio and text (needs span wrapper from JS below) */
    .leaflet-control-layers .leaflet-control-layers-base label span.layer-name {
      margin-left: 8px !important; /* match overlay "gap: 8px" */
    }

    /* Base layers: align radio + wrapped label text */
    .leaflet-control-layers .leaflet-control-layers-base label {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      margin: 0;
      white-space: nowrap;
    }
    .leaflet-control-layers .leaflet-control-layers-base input[type="radio"] {
      margin: 0;
    }

    /* ===== Azimuth measurement tool ===== */

    .az-arrow-head {
      font-size: 18px;
      line-height: 18px;
      color: #111;
      text-shadow: 0 1px 2px rgba(255,255,255,0.9);
      transform-origin: 50% 60%;
    }

    .az-tip div {
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      white-space: nowrap;
    }

    .az-btn {
      padding: 8px 10px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
    }

    .az-btn.active {
      background: #111;
      color: #fff;
    }


    @media (max-width: 900px) {
      .modalGrid { grid-template-columns: 1fr; }
    }
    
  </style>
</head>

<body>
<div id="wrap">
  <!-- Monthly modal -->
  <div id="monthlyModal" class="modal" style="display:none;">
    <div class="modalCard">
      <div class="modalHeader">
        <div id="monthlyTitle" style="font-weight:700;">Samlet oversigt</div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnMonthlyPrint" class="modalClose">Udskriv</button>
          <button id="btnMonthlyClose" class="modalClose">Luk</button>
        </div>
      </div>

      <div class="modalBody">

        <!-- NEW: mini map first (full width) -->
        <div id="overviewTop" class="docCard" style="margin-bottom:12px;">
          <div class="docTitle">Kortudsnit af valgt lokation</div>
          <div class="small" style="margin-bottom:8px;">
            Udsnittet viser området omkring den valgte markør.
          </div>
          <div id="miniMap"></div>
        </div>

        <!-- 2 columns below -->
        <div id="overviewDoc" class="overviewDoc">
          <div id="overviewLeft" class="docCard"></div>
          <div id="overviewRight" class="docCard"></div>
        </div>

        <!-- Your existing charts grid -->
        <div class="modalGrid" style="margin-top:12px;">
          <div class="modalPanel">
            <div class="small"><b>Estimeret El-Energi balance (kWh)</b></div>
            <canvas id="chartMonthlyEnergy"></canvas>
            <img id="printChartMonthlyEnergy" style="display:none; width:100%; height:auto;" alt="Chart energy">
          </div>

          <div class="modalPanel">
            <div class="small"><b>Estimerede omkostninger og besparelser (DKK)</b></div>
            <canvas id="chartMonthlyCost"></canvas>
            <img id="printChartMonthlyCost" style="display:none; width:100%; height:auto;" alt="Chart cost">
          </div>
        </div>

        <!-- NEW: plans printed in the modal -->
        <div id="overviewPlansSection">
          <div class="modalPanel" style="margin-top:12px;">
            <div class="small"><b>Lokalplaner og vejledning</b></div>

            <div id="overviewPlansGrid" class="plansDocGrid">
              <div id="overviewPlansLeft" class="docCard"></div>
              <div id="overviewPlansRight" class="docCard"></div>
            </div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- User Guide modal -->
  <div id="guideModal" class="modal" style="display:none;">
    <div class="modalCard">
      <div class="modalHeader">
        <div style="font-weight:700;">Brugervejledning</div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnGuidePrint" class="modalClose">Udskriv</button>
          <button id="btnGuideClose" class="modalClose">Luk</button>
        </div>
      </div>

      <div class="modalBody">
        <div class="guideDoc">
          <!-- LEFT: steps/explanations -->
          <div class="docCard">
            <h2 class="docTitle">Sådan bruger du værktøjet</h2>
            <div class="docMeta">
              Følg trinene her for at lave en beregning og forstå resultaterne.
            </div>

            <div class="guideSteps">
              <div class="guideStep">
                <div class="guideStepTitle">1) Vælg lokation</div>
                <div class="guideStepText">
                  Klik på kortet, eller brug adresse-søgningen. Markøren viser det valgte punkt.
                  Når lokationen er valgt, tryk på <b>“Opdater oversigt”</b>.
                </div>
              </div>

              <div class="guideStep">
                <div class="guideStepTitle">2) Udfyld grundindstillinger</div>
                <div class="guideStepText">
                  <ul class="docList">
                    <li><b>Årligt forbrug:</b> dit elforbrug pr. år (kWh/år).</li>
                    <li><b>Solpanel størrelse (kWp):</b> anlæggets installerede effekt.</li>
                    <li><b>Batteri (kWh):</b> 0 hvis du ikke har batteri.</li>
                    <li><b>Pris-scenarie:</b> påvirker kun omkostninger/besparelser (DKK).</li>
                  </ul>
                </div>
              </div>

              <div class="guideStep">
                <div class="guideStepTitle">3) (Valgfrit) Avancerede indstillinger</div>
                <div class="guideStepText">
                  Brug standardværdier hvis du er i tvivl. Justér kun hvis du kender dine forhold:
                  <ul class="docList">
                    <li><b>PR:</b> samlet systemeffektivitet (typisk 0,75–0,85).</li>
                    <li><b>Hældning &amp; Azimuth:</b> tagets orientering.</li>
                    <li><b>SoC min/max:</b> batteribegrænsninger for levetid.</li>
                    <li><b>Effektgrænser (kW):</b> hvis inverter/batteri har begrænsninger.</li>
                  </ul>
                </div>
              </div>

              <div class="guideStep">
                <div class="guideStepTitle">4) Forstå output</div>
                <div class="guideStepText">
                  <ul class="docList">
                    <li><b>Solpanel Resultater:</b> forventet årlig produktion (kWh/år) og peak-værdier.</li>
                    <li><b>Årlig Simulation:</b> omkostninger uden/med solceller samt besparelse.</li>
                    <li><b>Månedlig oversigt:</b> grafer for energi (kWh) og økonomi (DKK).</li>
                    <li><b>Lokalplaner:</b> standard vejledning + evt. relevante planer for lokationen.</li>
                  </ul>
                </div>
              </div>

              <div class="guideStep">
                <div class="guideStepTitle">Tip</div>
                <div class="guideStepText">
                  Start med standardværdier og ændr én ting ad gangen (kWp, azimuth, batteri)
                  for at se hvordan resultatet ændrer sig.
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT: images/screenshots (placeholders you can replace) -->
          <div class="docCard">
            <h2 class="docTitle">Screenshots / Eksempler</h2>
            <div class="guideImgGrid">
              <figure class="guideFigure">
                <img class="guideImg" src="/static/screenshots/Location_Input.png" alt="Vælg lokation" style="width:100%; border-radius:10px; border:1px solid #ddd;">
                <figcaption class="small">Eksempel: vælg punkt på kortet.</figcaption>
              </figure>

              <figure class="guideFigure">
                <img class="guideImg" src="/static/screenshots/Azimuth_Input.png" alt="Vælg lokation" style="width:100%; border-radius:10px; border:1px solid #ddd;">
                <figcaption class="small">Eksempel: Vælg Azimuth.</figcaption>
              </figure>

              <figure class="guideFigure">
                <img class="guideImg" src="/static/screenshots/Settings_Input.png" alt="Vælg lokation" style="width:100%; border-radius:10px; border:1px solid #ddd;">
                <figcaption class="small">Eksempel: udfyld kWh/år og kWp.</figcaption>
              </figure>

              <figure class="guideFigure">
                <img class="guideImg" src="/static/screenshots/Output_Grafer.png" alt="Vælg lokation" style="width:100%; border-radius:10px; border:1px solid #ddd;">
                <figcaption class="small">Eksempel: læs kWh- og DKK-grafer.</figcaption>
              </figure>

              <figure class="guideFigure">
                <img class="guideImg" src="/static/screenshots/Output_Planer.png" alt="Vælg lokation" style="width:100%; border-radius:10px; border:1px solid #ddd;">
                <figcaption class="small">Eksempel: links og relevante uddrag.</figcaption>
              </figure>
            </div>

            <!-- Optional: real images later
            <img class="guideImg" src="img/step1.png" alt="Step 1">
            -->
          </div>
        </div>
      </div>
    </div>
  </div>


  <div id="side">
    <h1>Inputs</h1> 
    <details class="section" open>
      <summary>Indstillinger for anlæg</summary>
      <div class="body">

        <div class="row">
          <label>
            <b>Årlig forbrug (kWh/år)</b>
            <span class="qm" data-tip="Indtast husstandens samlede elforbrug pr. år. Kan typisk findes på din årsopgørelse fra elselskabet.">?</span>
          </label>
          <input id="annual_kwh" type="number" value="4200" step="100" min="0">
          <div class="hr"></div>
        </div>

        <div class="row">
          <label>
            <b>Solpanel størrelse (kWp)</b>
            <span class="qm" data-tip="Installeret effekt af solcelleanlægget. 1 kWp svarer typisk til ca. 3–4 paneler afhængigt af paneltype.">?</span>
          </label>
          <input id="kwp" type="number" step="0.1" value="1.0" min="0">
          <div class="hr"></div>
        </div>

        <div class="row">
          <label>
            <b>Batteri kapacitet (kWh) (0 = intet batteri)</b>
            <span class="qm" data-tip="Batteriets lagringskapacitet. 0 betyder ingen batterilagring. Typisk 5–15 kWh for parcelhuse.">?</span>
          </label>
          <input id="batt_kwh" type="number" step="0.5" value="0" min="0">
          <div class="hr"></div>
        </div>

        <div class="row">
          <label>
            <b>Pris-scenarie</b>
            <span class="qm" data-tip="2025: Faktiske historiske elpriser inkl. fuld elafgift (0,72 kr/kWh). 
            2026: Fremskrevet scenarie baseret på 2025-markedspriser, men med reduceret elafgift på 0,01 kr/kWh for at afspejle kommende afgiftsændring.">?</span>
          </label>
          <select id="price_scenario">
            <option value="2025_real" selected>2025 (Historisk: elafgift 0,72 dkk/kWh)</option>
            <option value="2026_projection">2026 (Fremskrevet: elafgift 0,01 dkk/kWh)</option>
          </select>
        </div>

        <div class="row" id="row_elafgift_custom" style="display:none;">
          <label>
            Custom elafgift (DKK/kWh)
            <span class="qm" data-tip="Bruges kun hvis du aktiverer et custom scenarie. Angiver elafgift i kr/kWh som lægges oveni spotpris og tariffer.">?</span>
          </label>
          <input id="elafgift_custom" type="number" step="0.01" value="0.01" min="0">
        </div>

      </div>
    </details>

    <details class="section">
      <summary>Avancerede indstillinger</summary>
      <div class="body">
        <label>
          Herunder findes avancerede instillinger for solpanel og batteri. Disse indstillinger påvirker nøjagtigheden. Du kan ofte bruge standardværdierne til en overslagsberegning.
        </label>

        <details class="section" open>
          <summary>Avancerede Solpanel indstillinger</summary>
          <div class="body">
            <!-- PV advanced -->

            <div class="row">
              <label>
                <b>Virkningsgrad (PR) (0.75 = 75%)</b>
                <span class="qm" data-tip="Performance Ratio (PR) beskriver systemets samlede effektivitet inkl. tab i inverter, kabler, temperatur m.m. Typisk 0.75–0.85.">?</span>
              </label>
              <input id="pr" type="number" step="0.01" value="0.75" min="0" max="1.2">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Hældning (°)</b>
                <span class="qm" data-tip="Tagets hældning i grader. Hældningen påvirker hvor meget solindstråling panelerne modtager over året.">?</span>
              </label>
              <input id="tilt" type="number" step="1" value="40">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Retning / azimuth (°) (180 = syd)</b>
                <span class="qm" data-tip="Retning på taget: 0° = nord, 90° = øst, 180° = syd, 270° = vest. Brug måleværktøjet på kortet for at bestemme vinklen.">?</span>
              </label>
              <input id="az" type="number" step="1" value="180">
            </div>

          </div>
        </details>

        <details class="section" open>
          <summary>Avancerede Batteri indstillinger</summary>
          <div class="body">
            <!-- Battery advanced -->

            <div class="row">
              <label>
                <b>Start SoC (0-1) (0.5 = 50% opladt)</b>
                <span class="qm" data-tip="State of Charge ved simuleringens start. 0.5 betyder 50% opladet batteri.">?</span>
              </label>
              <input id="soc_init" type="number" step="0.05" value="0.5" min="0" max="1">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Minimum SoC (0-1) (0.1 = 10% opladt)</b>
                <span class="qm" data-tip="Laveste tilladte opladningsniveau. Begrænser dybdeafladning og kan forlænge batteriets levetid.">?</span>
              </label>
              <input id="soc_min" type="number" step="0.05" value="0.1" min="0" max="1">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Maksimal SoC (0-1) (0.9 = 90% opladt)</b>
                <span class="qm" data-tip="Højeste tilladte opladningsniveau. Begrænser fuldopladning og kan forlænge batteriets levetid.">?</span>
              </label>
              <input id="soc_max" type="number" step="0.05" value="0.9" min="0" max="1">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Maksimal opladningseffekt (kW) (blank = uendelig)</b>
                <span class="qm" data-tip="Maksimal effekt batteriet kan oplades med. Ofte begrænset af inverter eller batteristyring. Tomt felt betyder ingen begrænsning.">?</span>
              </label>
              <input id="p_charge_kw" type="number" step="0.5" value="" min="0">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Maksimal afladningseffekt (kW) (blank = uendelig)</b>
                <span class="qm" data-tip="Maksimal effekt batteriet kan levere. Tomt felt betyder ingen begrænsning.">?</span>
              </label>
              <input id="p_discharge_kw" type="number" step="0.5" value="" min="0">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Opladnings effektivitet (0-1) (0.95 = 95%)</b>
                <span class="qm" data-tip="Opladnings effektivitet er den energi, der tilføres batteriet, divideret med den energi, der bruges af opladeren.">?</span>
              </label>
              <input id="eta_c" type="number" step="0.01" value="0.95" min="0" max="1">
              <div class="hr"></div>
            </div>

            <div class="row">
              <label>
                <b>Afladnings effektivitet (0-1) (0.95 = 95%)</b>
                <span class="qm" data-tip="Afladnings effektivitet er den energi, der leveres fra batteriet, divideret med den energi, der tappes fra batteriet.">?</span>
              </label>
              <input id="eta_d" type="number" step="0.01" value="0.95" min="0" max="1">
            </div>

          </div>
        </details>

      </div>
    </details>

    <button id="btnSummary" class="btn-main btn-update">
      Opdater oversigt
    </button>

    <button id="btnMonthly" class="btn-main btn-overview">
      Samlet oversigt
    </button>

    <button id="btnGuide" class="btn-guide">
      Brugervejledning
    </button>

    <div class="hr"></div>
    <h2>Resultater</h2>
    <div class="small"><b>Status:</b> <span id="status">Klik på kort for at vælge lokation. Tryk derefter på Opdater oversigt.</span></div>
    <div class="small"><b>Valgt koordinat:</b> <span id="coord">—</span></div>

    <div id="summary"></div>
    <div class="hr"></div>
    <div id="simulationYear"></div>

    <div class="hr"></div>
    <h4 style="margin: 8px 0;">Lokalplaner</h4>
    <div id="bevaringskodeBox">Bevaringskategori:</div>
    <div id="plans"></div>
  </div>

  <div id="map"></div>
</div>

<script>
  const summaryEl = document.getElementById("summary");
  const plansEl = document.getElementById("plans");
  const coord = document.getElementById("coord");
  const statusEl = document.getElementById("status");

  const kwpEl = document.getElementById("kwp");
  const prEl = document.getElementById("pr");
  const tiltEl = document.getElementById("tilt");
  const azEl = document.getElementById("az");
  const annualKwhEl = document.getElementById("annual_kwh");

  const bevaringskodeEl = document.getElementById("bevaringskodeBox");

    //Simulering Solpanel
  const simBox = document.getElementById("simBox");
  const simYearEl = document.getElementById("simulationYear");

    //Simulering med Batteri
  const battKwhEl = document.getElementById("batt_kwh");
  const socInitEl = document.getElementById("soc_init");
  const socMinEl = document.getElementById("soc_min");
  const socMaxEl = document.getElementById("soc_max");
  const pChargeEl = document.getElementById("p_charge_kw");
  const pDischargeEl = document.getElementById("p_discharge_kw");
  const etaCEl = document.getElementById("eta_c");
  const etaDEl = document.getElementById("eta_d");

  const priceScenarioEl = document.getElementById("price_scenario");
  const btnSummary = document.getElementById("btnSummary");
  const btnMonthly = document.getElementById("btnMonthly");

  let hasResults = false;
  let selected = null;
  let marker = null;

  let lastYearSim = null;
  let chartMonthlyEnergy = null;
  let chartMonthlyCost = null;
  let lastComputedScenario = null;   // e.g. "2025_real" / "2026_projection"
  let lastComputedYear = null;       // 2025 / 2026 (display year)
  let isCalculating = false;

  let miniMap = null;
  let miniMarker = null;
  let miniCircle = null;

  let lastSummary = null;

  async function getJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  function setMonthlyEnabled(enabled){
    btnMonthly.disabled = !enabled;
    btnMonthly.title = enabled ? "" : "Kør først “Opdater oversigt” for at åbne samlet oversigt.";
  }

  function setUpdateLoading(isLoading){
    if (!btnSummary) return;

    if (isLoading){
      btnSummary.classList.add("btn-loading");
      btnSummary.disabled = true;

      // Save original text once
      if (!btnSummary.dataset.originalText){
        btnSummary.dataset.originalText = btnSummary.textContent.trim();
      }

      btnSummary.innerHTML = `<span class="btn-spinner"></span>Beregner…`;
    } else {
      btnSummary.classList.remove("btn-loading");
      btnSummary.disabled = false;

      const original = btnSummary.dataset.originalText || "Opdater oversigt";
      btnSummary.textContent = original;
    }
  }


  async function printMonthlyOverview() {
    populateMonthlyOverview();
    openMonthlyModal();

    // Let layout + charts paint before printing
    await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

    document.body.classList.add("print-modal");
    window.print();
    document.body.classList.remove("print-modal");
  }

  function getDisplayYear() {
    const sc = priceScenarioEl ? priceScenarioEl.value : null;
    if (sc === "2025_real") return 2025;
    if (sc === "2026_projection") return 2026;
    return 2025; // fallback
  }

  function refreshYearLabels() {
    const y = getDisplayYear();

    const titleEl = document.getElementById("monthlyTitle");
    if (titleEl) titleEl.textContent = `Samlet oversigt (${y})`;

    const btnEl = document.getElementById("btnMonthly");
    if (btnEl) btnEl.textContent = `Samlet oversigt (${y})`;
  }

  function addBatteryParams(params) {
    params.set("battery_kwh", battKwhEl.value);
    params.set("soc_init", socInitEl.value);
    params.set("soc_min", socMinEl.value);
    params.set("soc_max", socMaxEl.value);

    // blank => don't send (backend will treat as None)
    if (pChargeEl.value !== "") params.set("p_charge_kw", pChargeEl.value);
    if (pDischargeEl.value !== "") params.set("p_discharge_kw", pDischargeEl.value);

    params.set("eta_charge", etaCEl.value);
    params.set("eta_discharge", etaDEl.value);
  }

  function openMonthlyModal() {
    document.getElementById("monthlyModal").style.display = "flex";

    // Let DOM paint, then build/refresh minimap
    requestAnimationFrame(() => {
      updateMiniMap();
    });
  }

  function closeMonthlyModal() {
    document.getElementById("monthlyModal").style.display = "none";
  }

  function ensureMiniMap() {
    const el = document.getElementById("miniMap");
    if (!el) return; // miniMap container not in DOM yet
    if (miniMap) return;

    // Create a “static screenshot-like” map (no interactions)
    miniMap = L.map("miniMap", {
      zoomControl: false,
      attributionControl: false,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      tap: false,
      touchZoom: false
    });

    // Use OSM tiles for the mini map
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19
    }).addTo(miniMap);

    miniMarker = L.marker([0, 0], { interactive: false }).addTo(miniMap);

    // Optional: a small radius ring around the point (looks “selection-ish”)
    miniCircle = L.circle([0, 0], {
      radius: 35, // meters
      interactive: false
    }).addTo(miniMap);
  }

  function updateMiniMap(){
    const el = document.getElementById("miniMap");
    if (!el) return;
    if (!selected) return;

    const center = [selected.lat, selected.lon];
    const z = 18;

    if (!miniMap){
      miniMap = L.map(el, {
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        tap: false,
        touchZoom: false
      }).setView(center, z);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19
      }).addTo(miniMap);

      miniMarker = L.marker(center, { interactive:false }).addTo(miniMap);
    } else {
      miniMap.setView(center, z, { animate: false });
      if (miniMarker) miniMarker.setLatLng(center);
      miniMap.invalidateSize();
    }
  }

  function populateMonthlyOverview() {
    const box = document.getElementById("modalOverview");
    if (!box) return;

    const coordText = (selected)
      ? `${selected.lat.toFixed(5)}, ${selected.lon.toFixed(5)}`
      : "—";

    const yearText = (lastYearSim?.inputs?.year) ? String(lastYearSim.inputs.year) : "—";
    const scenarioText = priceScenarioEl?.value ? escapeHtml(priceScenarioEl.value) : "—";

    const summaryHtml = document.getElementById("summary")?.innerHTML || "<div class='small'>Ingen PV-oversigt endnu. Tryk “Opdater oversigt”.</div>";
    const yearHtml = document.getElementById("simulationYear")?.innerHTML || "<div class='small'>Ingen årlig simulering endnu. Tryk “Opdater oversigt”.</div>";

    box.innerHTML = `
      <div class="small" style="margin-bottom:8px;">
        <b>Valgt koordinat:</b> ${escapeHtml(coordText)}
        <span style="margin-left:10px;"><b>År:</b> ${escapeHtml(yearText)}</span>
        <span style="margin-left:10px;"><b>Pris-scenarie:</b> ${scenarioText}</span>
      </div>

      <div class="hr"></div>

      <div style="margin-bottom:10px;">
        ${summaryHtml}
      </div>

      <div class="hr"></div>

      <div>
        ${yearHtml}
      </div>
    `;
      document.getElementById("overviewLeft").innerHTML  = buildYearSimDocHtml(lastYearSim);
      document.getElementById("overviewRight").innerHTML = buildPvDocHtml(lastSummary);

      const std = buildStandardPlan();
      document.getElementById("overviewPlansLeft").innerHTML  = buildStandardPlanDocHtml(std);
      document.getElementById("overviewPlansRight").innerHTML = buildFoundPlansDocHtml(lastSummary?.plan);

      renderMonthlyCharts(lastYearSim);
  }

  function printMonthlyModal() {
    populateMonthlyOverview(); // ensure modal HTML exists

    // Remove class only AFTER printing is finished
    const cleanup = () => {
      document.body.classList.remove("print-modal");
      window.removeEventListener("afterprint", cleanup);
    };
    window.addEventListener("afterprint", cleanup);

    document.body.classList.add("print-modal");

    // Give the browser 1 tick to apply styles before print snapshot
    setTimeout(() => window.print(), 0);
  }

  function swapChartsForPrint(enable){
    const c1 = document.getElementById("chartMonthlyEnergy");
    const c2 = document.getElementById("chartMonthlyCost");
    const i1 = document.getElementById("printChartMonthlyEnergy");
    const i2 = document.getElementById("printChartMonthlyCost");

    if (!c1 || !c2 || !i1 || !i2) return;

    if (enable){
      // IMPORTANT: ensure canvases are visible during snapshot
      c1.style.display = "block";
      c2.style.display = "block";

      // Snapshot
      i1.src = c1.toDataURL("image/png", 1.0);
      i2.src = c2.toDataURL("image/png", 1.0);

      // Show images, hide canvases (print uses images)
      c1.style.display = "none";
      c2.style.display = "none";
      i1.style.display = "block";
      i2.style.display = "block";
    } else {
      // Restore interactive view
      i1.style.display = "none";
      i2.style.display = "none";
      c1.style.display = "block";
      c2.style.display = "block";
    }
  }

  function renderMonthlyCharts(yearSim) {
    if (!yearSim || !yearSim.monthly) {
      throw new Error("Ingen årlig og månedlig data tilgængelig. Tryk på Opdater oversigt først");
    }

    const m = yearSim.monthly;
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    const labels = m.month.map(s => {
      const mm = Number(String(s).split("-")[1]); 
      return monthNames[mm - 1];
    });

    // Destroy existing charts
    if (chartMonthlyEnergy) chartMonthlyEnergy.destroy();
    if (chartMonthlyCost) chartMonthlyCost.destroy();

    // 1) Monthly energy balance (stacked)
    chartMonthlyEnergy = new Chart(document.getElementById("chartMonthlyEnergy"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Forbrug", data: m.load_kwh, backgroundColor: "rgba(212,232,193,0.85)" },
          { label: "Solpanel", data: m.pv_kwh, backgroundColor: "rgba(141,184,124,0.85)" },
          { label: "Import", data: m.import_kwh, backgroundColor: "rgba(245,215,105,0.9)" },
          { label: "Eksport", data: m.export_kwh, backgroundColor: "rgba(237,138,63,0.9)" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          x: {
            grid: { display: false }
          },
          y: {
            title: {
              display: true,
              text: "kWh",
              font: {
                weight: "bold",
                size: 13
              }
            },
            grid: {
              color: "#eee"
            }
          }
        }
      }
    });

    // 2) Monthly costs/savings (bars)
    chartMonthlyCost = new Chart(document.getElementById("chartMonthlyCost"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Uden solceller", data: m.baseline_cost_dkk, backgroundColor: "rgba(212,232,193,0.85)" },
          { label: "Med solceller", data: m.system_cost_dkk, backgroundColor: "rgba(141,184,124,0.85)" },
          { label: "Besparelse", data: m.savings_dkk, backgroundColor: "rgba(237,138,63,0.9)" }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        scales: {
          x: {
            grid: { display: false }
          },
          y: {
            title: {
              display: true,
              text: "DKK",
              font: {
                weight: "bold",
                size: 13
              }
            },
            grid: {
              color: "#eee"
            }
          }
        }
      }
    });

  }

  function renderSimulationYear(data) {
    const s = data.summary;
    const year = getUiYear();
    const staleBadge = isUiStale() ? `<span class="warnPill">Ikke opdateret</span>` : "";

    function fmt(x, digits = 2) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "—";
      return Number(x).toFixed(digits);
    }
    function pct(x) {
      if (x === null || x === undefined) return "—";
      return (Number(x) * 100).toFixed(1) + " %";
    }

    simYearEl.innerHTML = `
      <details class="section">
        <summary>
          Årlig simulation (${year} ${staleBadge})
          <span class="badge">${fmt(s.savings_dkk)} DKK</span>
        </summary>
        <div class="body">
          <details class="section" open>
            <summary>Estimerede beregninger</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Årlige elomkostninger <b>uden</b> solceller</div>
                <div class="v">${fmt(s.baseline_cost_dkk)} DKK</div>

                <div class="k">Årlige elomkostninger <b>med</b> solceller</div>
                <div class="v">${fmt(s.system_cost_dkk)} DKK</div>

                <div class="k">Besparelser</div>
                <div class="v"><b>${fmt(s.savings_dkk)} DKK</b></div>

                <div class="k">Forbrug</div>
                <div class="v">${fmt(s.load_kwh)} kWh</div>

                <div class="k">Solpanel produktion</div>
                <div class="v">${fmt(s.pv_kwh)} kWh</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Dækningsgrader</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Selvforbrug</div>
                <div class="v">${pct(s.self_consumption_ratio)}</div>

                <div class="k">Selvforsyningsgrad</div>
                <div class="v">${pct(s.self_sufficiency)}</div>
              </div>
            </div>
          </details>
        </div>
      </details>
    `;
  }

  function fmtNum(x, digits = 2) {
    if (x === null || x === undefined || Number.isNaN(Number(x))) return "—";
    return Number(x).toFixed(digits);
  }

  function fmtPct(x) {
    if (x === null || x === undefined || Number.isNaN(Number(x))) return "—";
    return (Number(x) * 100).toFixed(1) + " %";
  }

  function buildPvDocHtml(summaryData) {
    if (!summaryData) {
      return `<div class="docTitle">Solpanel Resultater</div><div class="small">Ingen data endnu – tryk “Opdater oversigt”.</div>`;
    }

    const s = summaryData.inputs || {};
    const yearKwh = Math.round(summaryData.energy_year_kwh_tmy ?? 0);
    const peakPoa = Math.round(summaryData.peak_poa_wm2 ?? 0);
    const peakPower = Math.round(summaryData.peak_power_w ?? 0);

    return `
      <div class="docTitle">Solpanel Resultater</div>
      <div class="docMeta">
        kWp=${fmtNum(s.kwp, 2)}, PR=${fmtNum(s.pr, 2)}, tilt=${fmtNum(s.tilt, 0)}°, az=${fmtNum(s.az, 0)}°
      </div>

      <div class="kvDoc">
        <div class="k">Årlig produktion (TMY/PVGIS)</div>
        <div class="v"><b>${yearKwh} kWh/år</b></div>

        <div class="k">Peak POA</div>
        <div class="v">${peakPoa} W/m²</div>

        <div class="k">Peak PV effekt</div>
        <div class="v">${peakPower} W</div>

        <div class="k">Lokation</div>
        <div class="v">${summaryData.location ? `${summaryData.location.lat.toFixed(5)}, ${summaryData.location.lon.toFixed(5)}` : "—"}</div>
      </div>
    `;
  }

  function buildYearSimDocHtml(yearSimData) {
    if (!yearSimData || !yearSimData.summary) {
      return `<div class="docTitle">Årlig Simulation</div><div class="small">Ingen data endnu – tryk “Opdater oversigt”.</div>`;
    }

    const s = yearSimData.summary;
    const displayYear = getUiYear();
    const staleNote = isUiStale()
      ? `<div class="small" style="margin-top:6px; color:#7a5c00;">
          Værdierne er ikke opdateret til valgt pris-scenarie endnu. Tryk “Opdater oversigt”.
        </div>`
      : "";

    return `
      <div class="docTitle">Årlig Simulation (Estimat) ${displayYear}</div>
      <div class="docMeta">Omkostninger inkluderer spot + tariffer (jf. valgt pris-scenarie). Omkostninger og besparelser er beregnet ud fra gennemsnitlige husstandsforbrug og kan derfor afvige fra dit forbrug</div>

      <div class="kvDoc">
        <div class="k">Basisomkostninger (uden solpanel)</div>
        <div class="v">${fmtNum(s.baseline_cost_dkk)} DKK</div>

        <div class="k">Omkostninger med solpanel</div>
        <div class="v">${fmtNum(s.system_cost_dkk)} DKK</div>

        <div class="k">Besparelser</div>
        <div class="v"><b>${fmtNum(s.savings_dkk)} DKK</b></div>

        <div class="k">Forbrug</div>
        <div class="v">${fmtNum(s.load_kwh)} kWh</div>

        <div class="k">Solpanel produktion</div>
        <div class="v">${fmtNum(s.pv_kwh)} kWh</div>

        <div class="k">Selvforbrug</div>
        <div class="v">${fmtPct(s.self_consumption_ratio)}</div>

        <div class="k">Selvforsyningsgrad</div>
        <div class="v">${fmtPct(s.self_sufficiency)}</div>
        
        ${staleNote}
      </div>
      
    `;
  }


  function setSelected(lat, lon) {
    selected = {lat, lon};
    coord.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    statusEl.textContent = "Lokation valgt. Tryk på Opdater oversigt.";

    if (marker) {
      marker.setLatLng([lat, lon]);
    }
    if (miniMap) updateMiniMap();
  }

  function tip(text) {
    return `<span class="qm" data-tip="${escapeAttr(text)}">?</span>`;
  }

  function renderSummary(data) {
    const s = data.inputs;

    const locationStr = `${data.location.lat.toFixed(5)}, ${data.location.lon.toFixed(5)}`;
    const settingsStr = `kWp=${Number(s.kwp).toFixed(2)}, PR=${Number(s.pr).toFixed(2)}, tilt=${Number(s.tilt).toFixed(0)}°, az=${Number(s.az).toFixed(0)}°`;

    const peakPoa = Math.round(data.peak_poa_wm2);
    const peakPower = Math.round(data.peak_power_w);
    const yearKwh = Math.round(data.energy_year_kwh_tmy);

    const html = `
      <details class="section">
        <summary>
          Solpanel Resultater
          <span class="badge">${yearKwh} kWh/år</span>
        </summary>

        <div class="body">

          <details class="section" open>
            <summary>Energi resultater</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Årlig total (TMY/PVGIS)</div>
                <div class="v">${yearKwh} kWh (år ${getUiYear()})</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Peak-værdier</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Peak POA</div>
                <div class="v">${peakPoa} W/m²</div>

                <div class="k">Peak Solpanel effekt</div>
                <div class="v">${peakPower} W</div>
              </div>
            </div>
          </details>

        </div>
      </details>
    `;


    summaryEl.innerHTML = html;

    // keep your plans rendering call:
    renderPlans(data.plan);
  }

  function applyLayerSwatches(layerControl, styleByDisplayName) {
    const root = layerControl.getContainer();

    // Add a title once
    if (!root.querySelector(".layers-title")) {
      const title = document.createElement("div");
      title.className = "layers-title";
      title.textContent = "Layers";
      root.insertBefore(title, root.firstChild);
    }

    // ---- 1) FIX BASE LAYERS: wrap text node into a span so spacing works ----
    const baseLabels = root.querySelectorAll(".leaflet-control-layers-base label");
    baseLabels.forEach(label => {
      const input = label.querySelector('input[type="radio"]');
      if (!input) return;

      // If already wrapped, do nothing
      if (label.querySelector("span.layer-name")) return;

      const name = label.textContent.trim(); // capture text BEFORE changing DOM

      const span = document.createElement("span");
      span.className = "layer-name";
      span.textContent = name;

      // Replace label contents with: [radio][span]
      label.replaceChildren(input, span);
    });

    // ---- 2) OVERLAYS: add swatches + ensure name span class ----
    const overlayLabels = root.querySelectorAll(".leaflet-control-layers-overlays label");
    overlayLabels.forEach(label => {
      const input = label.querySelector('input[type="checkbox"]');
      const span = label.querySelector("span"); // Leaflet creates span for overlays
      if (!input || !span) return;

      const name = span.textContent.trim();
      const st = styleByDisplayName[name];
      if (!st) return;

      span.classList.add("layer-name");

      let sw = label.querySelector(".layer-swatch");
      if (!sw) {
        sw = document.createElement("span");
        sw.className = "layer-swatch";
        label.appendChild(sw);
      }

      sw.style.borderColor = st.color || "#666";
      sw.style.background = st.fillColor || st.color || "#999";
      sw.style.opacity = (st.fillOpacity ?? 0.25);

      // Ensure order: input | name | swatch
      label.insertBefore(input, label.firstChild);
      label.insertBefore(span, input.nextSibling);
    });
  }

  function isUrl(s) {
    return typeof s === "string" && (s.startsWith("http://") || s.startsWith("https://"));
  }

  function niceLabel(key) {
    // Optional: rename keys to nicer labels
    const map = {
      plannavn: "Plan navn",
      planid: "Plan ID",
      plantype: "Plan type",
      status: "Status",
      doklink: "Dokument",
      link: "Link",
      url: "URL",
      doklink: "Dokument"
    };
    return map[key] || key;
  }

  function isEmptyVal(v) {
    return v === null || v === undefined || String(v).trim() === "";
  }

  function renderDetailSection(title, items) {
    const rows = items
      .filter(it => !isEmptyVal(it.value))
      .map(it => `
        <div class="detailRow">
          <div class="detailLabel">${escapeHtml(it.label)}</div>
          <div class="detailValue">${escapeHtml(String(it.value))}</div>
        </div>
      `)
      .join("");

    if (!rows) return "";

    return `
      <div class="detailSection">
        <div class="detailTitle">${escapeHtml(title)}</div>
        <div class="detailBody">${rows}</div>
      </div>
    `;
  }

  function renderDetails(details) {
    if (!details || !Array.isArray(details) || details.length === 0) {
      return "<div class='small'>Ingen ekstra detaljer.</div>";
    }

    const d = details[0];

    const sol = renderDetailSection("Sol", [
      { label: "Side", value: d.sol_side },
      { label: "Paragraf", value: d.sol_paragraf },
      { label: "Kommentar", value: d.kommentar_sol },
    ]);

    const vind = renderDetailSection("Vind", [
      { label: "Side", value: d.vind_side },
      { label: "Paragraf", value: d.vind_paragraf },
      { label: "Kommentar", value: d.kommentar_vind },
    ]);

    const batteri = renderDetailSection("Batteri", [
      { label: "Side", value: d.batteri_side },
      { label: "Paragraf", value: d.batteri_paragraf },
      { label: "Kommentar", value: d.kommentar_batteri },
    ]);

    const tekniske = renderDetailSection("Tekniske anlæg", [
      { label: "Side", value: d.tekniske_anlaeg_side },
      { label: "Paragraf", value: d.tekniske_anlaeg_paragraf },
      { label: "Kommentar", value: d.kommentar_tekniske_anlaeg },
    ]);

    const andet = renderDetailSection("Andet relevant regulering", [
      { label: "Side", value: d.andet_side },
      { label: "Paragraf", value: d.andet_paragraf },
      { label: "Kommentar", value: d.kommentar_andet_regulering },
    ]);

    const kort = renderDetailSection("Kort kommentar", [
      { label: "Kommentar", value: d.kommentar_kort },
    ]);

    const html = [sol, vind, batteri, tekniske, andet, kort].filter(Boolean).join("");

    return html || "<div class='small'>Ingen relevante områder fundet i detaljer.</div>";
  }

  function renderBevaringskode(data) {
    const code = data?.bevaringskode ?? null;

    if (code === null || code === undefined || String(code).trim() === "") {
      bevaringskodeEl.innerHTML = `
        <div><b>Bevaringskategori:</b> —</div>
        <div class="small">Ingen Bevaringskategori fundet for pågældende lokation (kontroller om markør står hvor husnummeret er vist).</div>
      `;
      return;
    }

    bevaringskodeEl.innerHTML = `
      <div><b>Bevaringskategori:</b> <span class="pill">${escapeHtml(String(code))}</span></div>
      <div class="small">Indikerer at bygningen har en gældende Bevaringskategori, kontroller gældende lovgivning for kategori.</div>
    `;
  }

  function buildPlansHtml(plans) {
    const standardPlan = buildStandardPlan();

    return `
      <details class="section" open>
        <summary>
          Planer og vejledning
          <span class="badge">${Array.isArray(plans) ? plans.length : 0}</span>
        </summary>
        <div class="body">
          ${renderStandardPlanItem(standardPlan)}
          ${renderFoundPlans(plans)}
        </div>
      </details>
    `;
  }

  function renderPlans(plans) {
    if (!plansEl) return;
    plansEl.innerHTML = buildPlansHtml(plans);
  }

  function buildStandardPlanDocHtml(std) {
    if (!std) return `<div class="docSectionTitle">Standard vejledning</div><div class="small">Ingen standarddata.</div>`;

    const links = (std.links || []).map(l => `
      <div class="detailRow">
        <div class="detailLabel">${escapeHtml(l.label)}</div>
        <div class="detailValue">
          <a href="${escapeAttr(l.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(l.linkText)}</a>
          ${l.desc ? `<div class="small" style="margin-top:4px;">${escapeHtml(l.desc)}</div>` : ""}
        </div>
      </div>
    `).join("");

    const hints = (std.hints || []).map(h => `<li>${escapeHtml(h)}</li>`).join("");

    return `
      <div class="docSectionTitle">Standard vejledning</div>
      <div class="small" style="margin-bottom:10px;">${escapeHtml(std.intro || "")}</div>

      <div class="detailSection" style="background:#fff;">
        <div class="detailTitle">Nyttige links</div>
        <div class="detailBody">${links}</div>
      </div>

      ${hints ? `
        <div class="detailSection" style="background:#fff;">
          <div class="detailTitle">Hvis der ikke findes en lokalplan ved punktet</div>
          <ul class="docList small">${hints}</ul>
        </div>
      ` : ""}
    `;
  }

  function buildFoundPlansDocHtml(plans) {
    if (!plans || !Array.isArray(plans) || plans.length === 0) {
      return `
        <div class="docSectionTitle">Lokalplaner på lokation</div>
        <div class="small">Ingen lokalplaner fundet for det valgte punkt.</div>
      `;
    }

    const items = plans.map((p, idx) => {
      const name = p.plannavn || p.plan_navn || p.navn || `Plan ${idx + 1}`;
      const id = p.planid ? String(p.planid) : "";
      const type = p.plantype || p.plan_type || "";
      const status = p.status || "";

      // Collect links (any field that looks like a URL)
      const urlFields = Object.entries(p)
        .filter(([k, v]) => typeof v === "string" && (v.startsWith("http://") || v.startsWith("https://")))
        .map(([k, v]) => `
          <div class="detailRow">
            <div class="detailLabel">${escapeHtml(niceLabel(k))}</div>
            <div class="detailValue">
              <a href="${escapeAttr(v)}" target="_blank" rel="noopener noreferrer">Åbn</a>
            </div>
          </div>
        `).join("");

      // Reuse your existing detailed rendering (already “same info”)
      const detailsHtml = p.details ? renderDetails(p.details) : "";

      return `
        <div class="planDocItem">
          <div class="planDocName">${escapeHtml(name)}${id ? ` <span class="pill">ID: ${escapeHtml(id)}</span>` : ""}</div>

          <div class="planDocMeta">
            ${type ? `Type: ${escapeHtml(type)} ` : ""}
            ${status ? `• Status: ${escapeHtml(status)}` : ""}
          </div>

          ${urlFields ? `
            <div class="detailSection" style="background:#fff;">
              <div class="detailTitle">Links</div>
              <div class="detailBody">${urlFields}</div>
            </div>
          ` : ""}

          ${detailsHtml ? `
            <div class="detailSection" style="background:#fff;">
              <div class="detailTitle">Relevante uddrag</div>
              <div class="detailBody">${detailsHtml}</div>
            </div>
          ` : ""}
        </div>
      `;
    }).join("");

    return `
      <div class="docSectionTitle">Lokalplaner på lokation</div>
      <div class="small">Fundet: <b>${plans.length}</b> plan(er)</div>
      ${items}
    `;
  }


  function renderFoundPlans(plans) {
    if (!plans || !Array.isArray(plans) || plans.length === 0) {
      return `<div class="small">Ingen lokalplaner fundet for det valgte punkt. Se “Standard vejledning” ovenfor.</div>`;
    }

    // Show a small count line (optional)
    const parts = [];
    parts.push(`<div class="small"><b>Fundet:</b> ${plans.length} plan(er)</div>`);

    plans.forEach((p, idx) => {
      const name = p.plannavn || p.plan_navn || p.navn || `Plan ${idx + 1}`;
      const id = p.planid ? String(p.planid) : "";
      const det = p.details?.[0] || {};

      function warn(flag, label) {
        return flag ? `<span class="warnPill">${escapeHtml(label)}</span>` : "";
      }

      const warnings = [
        warn(det.sol_relevant, "Sol"),
        warn(det.vind_relevant, "Vind"),
        warn(det.batteri_relevant, "Batteri"),
        warn(det.tekniske_anlaeg_relevant, "Teknik"),
        warn(det.andet_relevant_regulering, "Andet"),
      ].join("");

      parts.push(`
        <details class="planItem">
          <summary>
            ${escapeHtml(name)}
            ${id ? `<span class="pill">ID: ${escapeHtml(id)}</span>` : ""}
            ${warnings}
          </summary>
          <div class="planBody">
            <div class="kv">
              ${Object.entries(p).map(([k, v]) => {
                if (v === null || v === undefined || v === "") return "";

                // Keep your special rendering for details
                if (k === "details") {
                  return `<div style="grid-column: 1 / -1;">${renderDetails(v)}</div>`;
                }

                const keyLabel = niceLabel(k);
                const valStr = String(v);

                // Links become "Open document"
                if (isUrl(valStr)) {
                  return `
                    <div class="k">${escapeHtml(keyLabel)}</div>
                    <div class="v">
                      <a href="${escapeAttr(valStr)}" target="_blank" rel="noopener noreferrer">Åbn dokument</a>
                    </div>
                  `;
                }

                return `
                  <div class="k">${escapeHtml(keyLabel)}</div>
                  <div class="v">${escapeHtml(valStr)}</div>
                `;
              }).join("")}
            </div>
          </div>
        </details>
      `);
    });

    return parts.join("");
  }

  function renderStandardPlanItem(std) {
    // One collapsible planItem, same styling as the others
    return `
      <details class="planItem">
        <summary>
          ${escapeHtml(std.title)}
        </summary>
        <div class="planBody">
          <div class="small" style="margin-bottom: 10px;">
            ${escapeHtml(std.intro)}
          </div>

          <div class="kv">
            ${std.links.map(link => {
              return `
                <div class="k">${escapeHtml(link.label)}</div>
                <div class="v">
                  <a href="${escapeAttr(link.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link.linkText)}</a>
                  ${link.desc ? `<div class="small" style="margin-top:4px;">${escapeHtml(link.desc)}</div>` : ""}
                </div>
              `;
            }).join("")}
          </div>

          ${std.hints && std.hints.length
            ? `
              <div class="hr"></div>
              <div class="small"><b>Hvis der ikke findes en lokalplan ved punktet:</b></div>
              <ul class="small" style="margin: 8px 0 0 18px; padding: 0;">
                ${std.hints.map(h => `<li>${escapeHtml(h)}</li>`).join("")}
              </ul>
            `
            : ""
          }
        </div>
      </details>
    `;
  }

  function buildStandardPlan() {
    return {
      title: "Standard vejledning",
      intro:
        "Her er nyttige steder at starte – også selvom der er fundet en lokalplan. Brug dem til at forstå rammer, regler og bevaringsforhold.",
      links: [
        {
          label: "Rammer for lokalplanlægning",
          linkText: "Åbn rammer i DKPlan",
          url: "https://bornholm.viewer.dkplan.niras.dk/plan/24#/4487",
          desc: "Overblik over kommuneplanrammer og planlægning.",
        },
        {
          label: "Solceller, husstandsvind og jordvarme",
          linkText: "Åbn Bornholm.dk vejledning",
          url: "https://bornholm.dk/service-og-selvbetjening/by-og-bolig/byggeri-og-nedrivning/solcelleanlaeg-hustandsvindmoeller-jordvarme",
          desc: "Praktisk info om opførelse/ansøgning og typiske krav.",
        },
        {
          label: "Kort: fredning og bevaringsværdi",
          linkText: "Åbn kort",
          url: "https://drift.kortinfo.net/Map.aspx?page=ArealInformation&Site=Bornholm",
          desc: "Se fredede områder og fredede/bevaringsværdige bygninger.",
        },
        {
          label: "Aktuelle lokalplaner (index)",
          linkText: "Åbn lokalplan-index",
          url: "https://bornholm.viewer.dkplan.niras.dk/plan/23",
          desc: "Find og læs aktuelle lokalplaner på Bornholm.",
        },
        {
          label: "Retsinformation",
          linkText: "Åbn retsinformation.dk",
          url: "https://www.retsinformation.dk/",
          desc: "Søg i gældende love og bekendtgørelser (fx planloven og bygningsreglementet).",
        },
        {
          label: "Energiforbedring (SLKS PDF)",
          linkText: "Åbn vejledning (PDF)",
          url: "https://slks.dk/fileadmin/user_upload/SLKS/Omraader/Kulturarv/Bygningsfredning/Gode_raad_om_vedligeholdelse/13.1_Energiforbedring_af_fredede_og_bevaringsvaerdige_by.pdf",
          desc: "Gode råd til energiforbedringer af fredede og bevaringsværdige bygninger.",
        },
      ],
      hints: [
        "Tjek kortet for fredning/bevaringsværdi og se evt. Bevaringskode.",
        "Find relevante kommuneplanrammer (DKPlan) og lokale restriktioner.",
        "Slå de relevante regler op i Retsinformation (planlov, BR18 m.fl.).",
        "Hvis du er i tvivl: kontakt Bornholms Regionskommune med adresse/matrikel.",
      ],
    };
  }

  // Basic escaping to avoid breaking HTML if plan fields contain odd characters
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function escapeAttr(s) {
    // For href attributes
    return escapeHtml(s);
  }

  /* ===========================
    Azimuth measurement helpers
    =========================== */

  function normalizeDeg(deg) {
    let d = deg % 360;
    if (d < 0) d += 360;
    return d;
  }

  // Bearing from point A to B (0° = North, clockwise)
  function bearingDeg(a, b) {
    const lat1 = a.lat * Math.PI / 180;
    const lat2 = b.lat * Math.PI / 180;
    const dLon = (b.lng - a.lng) * Math.PI / 180;

    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) -
              Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

    const brng = Math.atan2(y, x) * 180 / Math.PI;
    return normalizeDeg(brng);
  }

  function makeAzimuthTool(map, azInputEl, statusEl, onStateChange) {
    let enabled = false;
    let dragging = false;
    let startLatLng = null;

    let arrowLine = null;
    let arrowHead = null;
    let tip = null;
    let perpTick = null;


    function clearGraphics() {
      if (arrowLine) { map.removeLayer(arrowLine); arrowLine = null; }
      if (arrowHead) { map.removeLayer(arrowHead); arrowHead = null; }
      if (tip) { map.removeLayer(tip); tip = null; }
      if (perpTick) { map.removeLayer(perpTick); perpTick = null; }
    }

    function setEnabled(on) {
      enabled = on;
      clearGraphics();
      dragging = false;
      startLatLng = null;

      if (enabled) {
        map.dragging.disable();
        map.doubleClickZoom.disable();
        statusEl.textContent = "Azimuth-værktøj: klik og træk for at måle retning.";
        map.getContainer().style.cursor = "crosshair";
      } else {
        map.dragging.enable();
        map.doubleClickZoom.enable();
        statusEl.textContent = "Azimuth-værktøj slået fra.";
        map.getContainer().style.cursor = "";
      }

      if (typeof onStateChange === "function") onStateChange(enabled);
    }

    function updateArrow(endLatLng) {
      const az = bearingDeg(startLatLng, endLatLng);
      azInputEl.value = String(Math.round(az));
      // --- Perpendicular tick at start point (screen-space so length is constant) ---
      const a = map.latLngToLayerPoint(startLatLng);
      const b = map.latLngToLayerPoint(endLatLng);

      const vx = b.x - a.x;
      const vy = b.y - a.y;
      const vlen = Math.hypot(vx, vy);

      // Only draw if user has moved enough pixels (avoid NaNs when start=end)
      if (vlen > 2) {
        // Unit perpendicular vector
        const px = -vy / vlen;
        const py =  vx / vlen;

        const tickLenPx = 24; // adjust to taste
        const half = tickLenPx / 2;

        const p1 = L.point(a.x + px * half, a.y + py * half);
        const p2 = L.point(a.x - px * half, a.y - py * half);

        const ll1 = map.layerPointToLatLng(p1);
        const ll2 = map.layerPointToLatLng(p2);

        if (!perpTick) {
          perpTick = L.polyline([ll1, ll2], {
            color: "red",
            weight: 3,
            opacity: 0.9
          }).addTo(map);
        } else {
          perpTick.setLatLngs([ll1, ll2]);
        }
      }


      const lineLatLngs = [startLatLng, endLatLng];
      if (!arrowLine) {
        arrowLine = L.polyline(lineLatLngs, {
          color: "#111",
          weight: 3
        }).addTo(map);
      } else {
        arrowLine.setLatLngs(lineLatLngs);
      }

      const html = `<div class="az-arrow-head" style="transform: rotate(${az}deg);">▲</div>`;
      const icon = L.divIcon({ className: "", html, iconSize: [20,20], iconAnchor: [10,10] });

      if (!arrowHead) {
        arrowHead = L.marker(endLatLng, { icon, interactive:false }).addTo(map);
      } else {
        arrowHead.setLatLng(endLatLng);
        arrowHead.setIcon(icon);
      }

      const label = `Azimuth: ${Math.round(az)}°`;

      if (!tip) {
        tip = L.marker(endLatLng, {
          icon: L.divIcon({
            className: "az-tip",
            html: `<div>${label}</div>`,
            iconSize: [120,24],
            iconAnchor: [10,30]
          }),
          interactive:false
        }).addTo(map);
      } else {
        tip.setLatLng(endLatLng);
        tip.setIcon(L.divIcon({
          className: "az-tip",
          html: `<div>${label}</div>`,
          iconSize: [120,24],
          iconAnchor: [10,30]
        }));
      }
    }

    function onMouseDown(e) {
      if (!enabled) return;
      dragging = true;
      startLatLng = e.latlng;
      clearGraphics();
      updateArrow(e.latlng);
    }

    function onMouseMove(e) {
      if (!enabled || !dragging) return;
      updateArrow(e.latlng);
    }

    function onMouseUp(e) {
      if (!enabled || !dragging) return;
      dragging = false;
      const az = bearingDeg(startLatLng, e.latlng);
      azInputEl.value = String(Math.round(az));
      setEnabled(false); // auto turn off after use
    }

    map.on("mousedown", onMouseDown);
    map.on("mousemove", onMouseMove);
    map.on("mouseup", onMouseUp);

    return {
      toggle: () => setEnabled(!enabled),
      isEnabled: () => enabled
    };
  }


  async function init() {
    const extraOverlays = {}; // name -> Leaflet layer
    const center = await getJSON("/api/center");
    plansEl.innerHTML = "<div class='small'>Tryk “Opdater oversigt” for at se planer og vejledning.</div>";
    // Map
    const map = L.map("map").setView([center.lat, center.lon], 10);

    // ===== Azimuth tool =====
    let azBtn = null;

    const azTool = makeAzimuthTool(map, azEl, statusEl, (enabled) => {
      if (!azBtn) return;
      azBtn.textContent = enabled ? "Stop retning / azimuth" : "Mål retning / azimuth";
      azBtn.classList.toggle("active", enabled);
    });

    const tooltip = document.createElement("div");
    tooltip.style.position = "fixed";
    tooltip.style.zIndex = "999999";
    tooltip.style.background = "#111";
    tooltip.style.color = "#fff";
    tooltip.style.padding = "10px 12px";
    tooltip.style.borderRadius = "10px";
    tooltip.style.fontSize = "12px";
    tooltip.style.lineHeight = "1.4";
    tooltip.style.maxWidth = "320px";
    tooltip.style.whiteSpace = "pre-line";
    tooltip.style.pointerEvents = "none";
    tooltip.style.display = "none";

    document.body.appendChild(tooltip);

    document.addEventListener("mouseover", e => {
      if (e.target.classList.contains("qm")) {
        tooltip.textContent = e.target.getAttribute("data-tip");
        tooltip.style.display = "block";
      }
    });

    document.addEventListener("mousemove", e => {
      if (tooltip.style.display === "block") {
        tooltip.style.left = (e.clientX + 15) + "px";
        tooltip.style.top = (e.clientY + 15) + "px";
      }
    });

    document.addEventListener("mouseout", e => {
      if (e.target.classList.contains("qm")) {
        tooltip.style.display = "none";
      }
    });


    const AzControl = L.Control.extend({
      onAdd: function() {
        const btn = L.DomUtil.create("button");
        btn.type = "button";
        btn.textContent = "Mål retning / azimuth";
        btn.className = "az-btn";
        azBtn = btn;

        L.DomEvent.disableClickPropagation(btn);
        L.DomEvent.on(btn, "click", (e) => {
          L.DomEvent.stop(e);
          azTool.toggle(); // callback updates text + class
        });

        return btn;
      }
    });

    map.addControl(new AzControl({ position: "bottomleft" }));

    // ----- Base layers -----

    // OpenStreetMap
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        minZoom: 10,
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }
    );

    // Esri satellite
    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        minZoom: 10,
        maxZoom: 19,
        attribution: "Tiles © Esri"
      }
    );

    // Default layer shown when map loads
    osm.addTo(map);


    // Marker visible immediately (like original)
    marker = L.marker([center.lat, center.lon]).addTo(map);
    setSelected(center.lat, center.lon);

    // ----- Layers from backend config (/api/layers) -----
    const overlays = {};
    const styleByDisplayName = {};

    const layersResp = await getJSON("/api/layers");
    const layerMeta = layersResp.layers || [];
    
    let boundsLayer = null;

    for (const info of layerMeta) {
      const gj = await getJSON(`/api/layers/${encodeURIComponent(info.id)}`);

      const style = info.style || { color: "#666", weight: 2, fillOpacity: 0.10 };

      const gjLayer = L.geoJSON(gj, {
        style,
        onEachFeature: (feature, layer) => {
          layer.on("click", (e) => setSelected(e.latlng.lat, e.latlng.lng));
        }
      });

      // Swatches keyed by the displayed GUI name
      styleByDisplayName[info.name] = style;

      // Add to layer control only if allowed
      if (info.show_in_control) {
        overlays[info.name] = gjLayer;
      }

      // Add to map by default if enabled
      if (info.enabled_by_default) {
        gjLayer.addTo(map);
        if (!boundsLayer) boundsLayer = gjLayer;
      }
    }

    // Optional: fit to the first default-enabled layer (if it exists)
    if (boundsLayer && boundsLayer.getBounds && boundsLayer.getBounds().isValid()) {
      const b = boundsLayer.getBounds();
      map.fitBounds(b.pad(0.15));
      map.setMaxBounds(b.pad(0.25));
    }

    L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: "Indtast adresse",
      collapsed: false
    })
    .on('markgeocode', function(e) {
      const latlng = e.geocode.center;

      setSelected(latlng.lat, latlng.lng);  // your existing function
      map.setView(latlng, 15);

      if (marker) marker.setLatLng(latlng);
    })
    .addTo(map);

    // Map click (works everywhere not caught by polygons)
    map.on("click", (e) => {
      setSelected(e.latlng.lat, e.latlng.lng);
    });

    // ----- Layer control (built from config-loaded overlays) -----
    const baseLayers = {
      "OpenStreetMap": osm,
      "Satellite (Esri)": esriSat
    };

    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // Add swatches once (must happen AFTER control is added)
    setTimeout(() => applyLayerSwatches(layerControl, styleByDisplayName), 0);

    // ===== Guide modal helpers =====
    function openGuideModal() {
      document.getElementById("guideModal").style.display = "flex";
    }
    function closeGuideModal() {
      document.getElementById("guideModal").style.display = "none";
    }

    // Open guide
    document.getElementById("btnGuide").onclick = () => {
      openGuideModal();
      statusEl.textContent = "Brugervejledning åbnet.";
    };

    // Close guide
    document.getElementById("btnGuideClose").onclick = closeGuideModal;

    // Click outside closes
    document.getElementById("guideModal").onclick = (e) => {
      if (e.target.id === "guideModal") closeGuideModal();
    };

    // Print guide
    document.getElementById("btnGuidePrint").onclick = () => {
      openGuideModal();

      const cleanup = () => {
        document.body.classList.remove("print-guide");
        window.removeEventListener("afterprint", cleanup);
      };
      window.addEventListener("afterprint", cleanup);

      document.body.classList.add("print-guide");
      setTimeout(() => window.print(), 0);
    };


    // Buttons
    document.getElementById("btnSummary").onclick = async () => {
      if (!selected) {
        statusEl.textContent = "Klik på kort for at vælge lokation.";
        return;
      }

      setUpdateLoading(true);
      setMonthlyEnabled(false);
      statusEl.textContent = "Beregner resultater…";

      const params = new URLSearchParams({
        lat: selected.lat,
        lon: selected.lon,
        kwp: kwpEl.value,
        pr: prEl.value,
        tilt: tiltEl.value,
        az: azEl.value,
        annual_kwh: annualKwhEl.value,
      });

      params.set("price_scenario", priceScenarioEl.value);
      addBatteryParams(params);

      // Optional: progress text
      if (simYearEl) simYearEl.innerHTML = "<div class='small'>Running yearly simulation…</div>";

      try {
        // Bevaringskode (non-fatal if it fails)
        try {
          bevaringskodeEl.innerHTML = "<div class='small'>Looking up Bevaringskode…</div>";
          const bk = await getJSON(`/api/bevaringskode?lat=${selected.lat}&lon=${selected.lon}`);
          renderBevaringskode(bk);
        } catch (e) {
          bevaringskodeEl.innerHTML = "<div class='small'>Bevaringskode lookup failed.</div>";
        }
        // 1) PV summary
        const summary = await getJSON(`/api/summary?${params.toString()}`);
        lastSummary = summary;

        // 3) Year simulation (FETCH ONCE)
        const year = "2025"; // keep const year (backend needs this)
        const yearParams = new URLSearchParams({
          lat: selected.lat,
          lon: selected.lon,
          kwp: kwpEl.value,
          pr: prEl.value,
          tilt: tiltEl.value,
          az: azEl.value,
          year: year,
          annual_kwh: annualKwhEl.value,
        });

        yearParams.set("price_scenario", priceScenarioEl.value);
        addBatteryParams(yearParams);

        const yearSim = await getJSON(`/api/simulate_year?${yearParams.toString()}`);
        lastYearSim = yearSim;

        // IMPORTANT: update "computed" markers BEFORE rendering,
        // so the "Ikke Opdateret" warning doesn't linger until a 2nd click.
        lastComputedScenario = priceScenarioEl.value;
        lastComputedYear = getDisplayYear(); // or scenarioToYear(lastComputedScenario) if you use that helper

        // Render after computed markers are set
        renderSummary(lastSummary);
        renderSimulationYear(lastYearSim);

        // Make sure labels/buttons match the *UI year* you want to show
        refreshYearLabels();

        statusEl.textContent = "Alle resultater opdateret.";
        hasResults = true;
        setMonthlyEnabled(true);


      } catch (err) {
        statusEl.textContent = "Fejl under beregning af resultater.";
        hasResults = false;
        setMonthlyEnabled(false);
        console.error(err);

        if (typeof simEl !== "undefined" && simEl) {
          simEl.innerHTML = "<pre class='small'>Fejl:\n" + escapeHtml(String(err)) + "</pre>";
        }
        if (typeof simYearEl !== "undefined" && simYearEl) {
          simYearEl.innerHTML = "<pre class='small'>Fejl:\n" + escapeHtml(String(err)) + "</pre>";
        }
      } finally {
        setUpdateLoading(false);
      }
    };

      // Modal close button
    document.getElementById("btnMonthlyClose").onclick = closeMonthlyModal;

    document.getElementById("btnMonthlyPrint").onclick = async () => {
      try {
        // Ensure all modal content is filled
        populateMonthlyOverview();
        openMonthlyModal();

        // Give layout time (important for Chart.js sizing)
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

        // Draw charts when modal is visible and sized
        renderMonthlyCharts(lastYearSim);

        // Wait 2 frames so canvas is definitely painted
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

        // Swap canvases to images for reliable printing
        swapChartsForPrint(true);

        const cleanup = () => {
          swapChartsForPrint(false);
          document.body.classList.remove("print-modal");
          window.removeEventListener("afterprint", cleanup);
        };
        window.addEventListener("afterprint", cleanup);

        document.body.classList.add("print-modal");

        // Small delay so <img> src is applied before print snapshot
        setTimeout(() => window.print(), 50);

      } catch (e) {
        console.error(e);
        statusEl.textContent = "Print-fejl: " + String(e);
      }
    };

    // Click outside card closes modal
    document.getElementById("monthlyModal").onclick = (e) => {
      if (e.target.id === "monthlyModal") closeMonthlyModal();
    };

    // Monthly overview button
    document.getElementById("btnMonthly").onclick = () => {
      if (btnMonthly.disabled) return;

      try {
        // Fill doc cards
        document.getElementById("overviewLeft").innerHTML  = buildYearSimDocHtml(lastYearSim);
        document.getElementById("overviewRight").innerHTML = buildPvDocHtml(lastSummary);

        // Fill plans
        const std = buildStandardPlan();
        document.getElementById("overviewPlansLeft").innerHTML  = buildStandardPlanDocHtml(std);
        document.getElementById("overviewPlansRight").innerHTML = buildFoundPlansDocHtml(lastSummary?.plan);

        // Open modal first so canvases have real size
        openMonthlyModal();

        // Now update minimap + charts after modal is visible
        requestAnimationFrame(() => {
          updateMiniMap();
          renderMonthlyCharts(lastYearSim);
        });

        statusEl.textContent = "Samlet oversigt åbnet.";
      } catch (err) {
        statusEl.textContent = String(err);
        console.error(err);
      }
    };

  priceScenarioEl.addEventListener("change", () => {
    // Do NOT change year labels to the new year yet.
    // Instead, re-render sections so they can show "Ikke opdateret" if stale.
    if (lastSummary) renderSummary(lastSummary);
    if (lastYearSim) renderSimulationYear(lastYearSim);

    // Optional: also lock the monthly button title/text to computed year
    refreshYearLabels(); // but make refreshYearLabels use getUiYear() (next section)
  });

    refreshYearLabels();

  }

  function scenarioToYear(sc){
    if (sc === "2025_real") return 2025;
    if (sc === "2026_projection") return 2026;
    return 2025;
  }

  function getUiYear(){
    // show the last computed year (safe), fallback to current selection only if never computed yet
    if (lastComputedYear) return lastComputedYear;
    return scenarioToYear(priceScenarioEl?.value);
  }

  function isUiStale(){
    // stale if user changed dropdown after last successful compute
    return lastComputedScenario && priceScenarioEl?.value !== lastComputedScenario;
  }

  setMonthlyEnabled(false);

  init().catch(err => {
    summaryEl.textContent = "Init error:\n" + err;
    statusEl.textContent = "Fejl under initialisering. Se detaljer i output.";
    console.error(err);
  });
</script>
</body>
</html>
