<!-- index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PV Map (Local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #wrap { display: grid; grid-template-columns: 380px 1fr; height: 100vh; }
    #side { padding: 12px; border-right: 1px solid #ddd; overflow: auto; }
    #map { height: 100vh; cursor: crosshair; }

    .row { margin-bottom: 10px; }
    label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
    input, select { width: 100%; padding: 6px; box-sizing: border-box; }
    button { padding: 10px; width: 100%; margin-bottom: 8px; }
    pre { background: #dddddd; padding: 10px; white-space: pre-wrap; }

    .small { font-size: 12px; color: #555; }
    .hr { height: 1px; background: #dddddd; margin: 10px 0; }
    #plans { font-size: 13px; }
    .planItem {
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 8px 0;
      background: #fff;
      overflow: hidden;
    }
    .planItem summary {
      cursor: pointer;
      padding: 10px;
      background: #f7f7f7;
      font-weight: 600;
      outline: none;
    }
    .planBody {
      padding: 10px;
    }
    .kv {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 6px 10px;
    }
    .kv .k { color: #555; font-size: 12px; }
    .kv .v { color: #111; word-break: break-word; }
    .kv a { color: #0b57d0; text-decoration: none; }
    .kv a:hover { text-decoration: underline; }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      margin-left: 8px;
    }

    #summary { font-size: 13px; }

    .section {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 8px 0;
      overflow: visible;
      background: #fff;
    }

    .section summary {
      cursor: pointer;
      padding: 10px;
      background: #f7f7f7;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section .body { padding: 10px; }

    .warnPill{
      display:inline-block;
      padding:2px 8px;
      margin-left:6px;
      border-radius:999px;
      background:#fff3cd;
      color:#7a5c00;
      font-size:12px;
      font-weight:600;
    }

    .row2 {
      display: grid;
      grid-template-columns: 160px 1fr;
      gap: 6px 10px;
      align-items: start;
    }
    .row2 .k { color: #555; font-size: 12px; }
    .row2 .v { color: #111; word-break: break-word; }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eee;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .detailSection{
      border: 1px solid #e6e6e6;
      border-radius: 10px;
      padding: 10px;
      margin: 10px 0;
      background: #fafafa;
    }

    .detailTitle{
      font-weight: 700;
      margin-bottom: 8px;
    }

    .detailRow{
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 8px;
      padding: 6px 0;
      border-top: 1px solid #eee;
    }

    .detailRow:first-child{ border-top: none; }

    .detailLabel{
      font-size: 12px;
      color: #555;
    }

    .detailValue{
      font-size: 13px;
      color: #111;
      white-space: pre-wrap;
      line-height: 1.35;
    }


    /* Tooltip */
    .qm {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid #bbb;
      font-size: 11px;
      color: #555;
      margin-left: 6px;
      cursor: help;
      position: relative;
      user-select: none;
    }

    .qm::after {
      content: attr(data-tip);
      position: absolute;
      left: 0px;
      top: 22px;
      min-width: 220px;
      max-width: 320px;
      white-space: normal;
      background: #111;
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.3;
      opacity: 0;
      pointer-events: none;
      transform: translateY(4px);
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 9999;
    }

    .qm:hover::after {
      opacity: 1;
      transform: translateY(0);
    }

    /* Geocoder search box styling */
    .leaflet-control-geocoder {
      width: 260px !important;
    }

    .leaflet-control-geocoder input {
      width: 100% !important;
      height: 36px;
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 8px;
    }

    /* softer placeholder look */
    .leaflet-control-geocoder input::placeholder {
      color: #666;
      opacity: 0.6;
    }

    .leaflet-control-geocoder-icon {
      display: none;
    }

    /* --- Layers control styling --- */
    .leaflet-control-layers {
      border-radius: 10px;
      overflow: hidden;
    }

    /* Title row inside the control */
    .layers-title {
      font-weight: 700;
      padding: 8px 10px;
      background: #f7f7f7;
      border-bottom: 1px solid #e6e6e6;
    }

    /* Make each overlay line a clean 3-column row: toggle | name | swatch */
    .leaflet-control-layers-overlays label {
      display: grid;
      grid-template-columns: 18px 1fr 18px;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin: 0;
      line-height: 1.2;
    }

    /* Keep checkbox aligned and not stretched */
    .leaflet-control-layers-overlays input[type="checkbox"] {
      margin: 0;
      justify-self: start;
    }

    /* Ensure the name doesn't collide with swatch */
    .leaflet-control-layers-overlays label .layer-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Put swatch on the right */
    .layer-swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 2px solid #666;
      margin: 0;
      justify-self: end;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .modalCard {
      width: min(1100px, 96vw);
      max-height: 92vh;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0,0,0,0.25);
      display: flex;
      flex-direction: column;
    }
    .modalHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f7f7f7;
      border-bottom: 1px solid #e6e6e6;
    }
    .modalClose {
      padding: 8px 10px;
      width: auto;
      margin: 0;
    }
    .modalBody {
      padding: 12px;
      overflow: auto;
    }
    .modalGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .modalPanel {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #fff;
    }

    /* ===== Fix Leaflet layers control being affected by global form styles ===== */
    .leaflet-control-layers input,
    .leaflet-control-layers select {
      width: auto !important;
      padding: 0 !important;
      box-sizing: content-box !important;
    }

    .leaflet-control-layers label {
      margin-bottom: 0 !important; /* your global label rule adds spacing */
    }

    /* Base layers: spacing between radio and text (needs span wrapper from JS below) */
    .leaflet-control-layers .leaflet-control-layers-base label span.layer-name {
      margin-left: 8px !important; /* match overlay "gap: 8px" */
    }

    /* Base layers: align radio + wrapped label text */
    .leaflet-control-layers .leaflet-control-layers-base label {
      display: flex;
      align-items: center;
      padding: 6px 10px;
      margin: 0;
      white-space: nowrap;
    }
    .leaflet-control-layers .leaflet-control-layers-base input[type="radio"] {
      margin: 0;
    }

    @media (max-width: 900px) {
      .modalGrid { grid-template-columns: 1fr; }
    }
    
  </style>
</head>

<body>
<div id="wrap">
  <!-- Monthly modal -->
  <div id="monthlyModal" class="modal" style="display:none;">
    <div class="modalCard">
      <div class="modalHeader">
        <div style="font-weight:700;">Monthly overview (2025)</div>
        <button id="btnMonthlyClose" class="modalClose">Close</button>
      </div>

      <div class="modalBody">
        <div class="modalGrid">
          <div class="modalPanel">
            <div class="small"><b>Energy balance (kWh)</b></div>
            <canvas id="chartMonthlyEnergy"></canvas>
          </div>

          <div class="modalPanel">
            <div class="small"><b>Costs and savings (DKK)</b></div>
            <canvas id="chartMonthlyCost"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>  
  <div id="side">
    <h1>Inputs</h1>

    <div class="row">
      <label>Yearly consumption (kWh/year)</label>
      <input id="annual_kwh" type="number" value="4200" step="100" min="0">
    </div>

    <div class="row">
      <label>PV size (kWp)</label>
      <input id="kwp" type="number" step="0.1" value="1.0" min="0">
    </div>

    <div class="row">
      <label>Battery size (kWh) (0 = off)</label>
      <input id="batt_kwh" type="number" step="0.5" value="0" min="0">
    </div>

    <details class="section">
      <summary>Advanced settings</summary>
      <div class="body">

        <!-- PV advanced -->
        <h4>PV Advanced</h4>
        <div class="row">
          <label>Performance ratio PR</label>
          <input id="pr" type="number" step="0.01" value="0.75" min="0" max="1.2">
        </div>

        <div class="row">
          <label>Tilt (°)</label>
          <input id="tilt" type="number" step="1" value="40">
        </div>

        <div class="row">
          <label>Azimuth (°)</label>
          <input id="az" type="number" step="1" value="180">
        </div>

        <div class="hr"></div>

        <!-- Battery advanced -->
        <h4>Battery Advanced</h4>
        <div class="row">
          <label>Initial SoC (0-1)</label>
          <input id="soc_init" type="number" step="0.05" value="0.5" min="0" max="1">
        </div>

        <div class="row">
          <label>SoC min (0-1)</label>
          <input id="soc_min" type="number" step="0.05" value="0.1" min="0" max="1">
        </div>

        <div class="row">
          <label>SoC max (0-1)</label>
          <input id="soc_max" type="number" step="0.05" value="0.9" min="0" max="1">
        </div>

        <div class="row">
          <label>Max charge power (kW) (blank = unlimited)</label>
          <input id="p_charge_kw" type="number" step="0.5" value="" min="0">
        </div>

        <div class="row">
          <label>Max discharge power (kW) (blank = unlimited)</label>
          <input id="p_discharge_kw" type="number" step="0.5" value="" min="0">
        </div>

        <div class="row">
          <label>Charge efficiency (0-1)</label>
          <input id="eta_c" type="number" step="0.01" value="0.95" min="0" max="1">
        </div>

        <div class="row">
          <label>Discharge efficiency (0-1)</label>
          <input id="eta_d" type="number" step="0.01" value="0.95" min="0" max="1">
        </div>

      </div>
    </details>


    <button id="btnSummary">Refresh summary</button>
    <button id="btnMonthly">Monthly overview (2025)</button>

    <div class="hr"></div>
    <h1>Outputs</h1>
    <div class="small"><b>Status:</b> <span id="status">Click map to set location. Use Refresh summary / Show plots afterwards.</span></div>
    <div class="small"><b>Selected:</b> <span id="coord">—</span></div>

    <div id="summary">No summary yet.</div>
    <div class="hr"></div>
    <div id="simulationYear">No yearly simulation yet.</div>



    <div class="hr"></div>
    <h4 style="margin: 8px 0;">Plans</h4>
    <div id="plans">No plans yet.</div>
  </div>

  <div id="map"></div>
</div>

<script>
  const summaryEl = document.getElementById("summary");
  const plansEl = document.getElementById("plans");
  const coord = document.getElementById("coord");
  const statusEl = document.getElementById("status");

  const kwpEl = document.getElementById("kwp");
  const prEl = document.getElementById("pr");
  const tiltEl = document.getElementById("tilt");
  const azEl = document.getElementById("az");
  const annualKwhEl = document.getElementById("annual_kwh");

    //Simulering Solpanel
  const simBox = document.getElementById("simBox");
  const simYearEl = document.getElementById("simulationYear");

    //Simulering med Batteri
  const battKwhEl = document.getElementById("batt_kwh");
  const socInitEl = document.getElementById("soc_init");
  const socMinEl = document.getElementById("soc_min");
  const socMaxEl = document.getElementById("soc_max");
  const pChargeEl = document.getElementById("p_charge_kw");
  const pDischargeEl = document.getElementById("p_discharge_kw");
  const etaCEl = document.getElementById("eta_c");
  const etaDEl = document.getElementById("eta_d");

  let selected = null;
  let marker = null;

  let lastYearSim = null;
  let chartMonthlyEnergy = null;
  let chartMonthlyCost = null;

  let lastSummary = null;

  async function getJSON(url) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  function addBatteryParams(params) {
    params.set("battery_kwh", battKwhEl.value);
    params.set("soc_init", socInitEl.value);
    params.set("soc_min", socMinEl.value);
    params.set("soc_max", socMaxEl.value);

    // blank => don't send (backend will treat as None)
    if (pChargeEl.value !== "") params.set("p_charge_kw", pChargeEl.value);
    if (pDischargeEl.value !== "") params.set("p_discharge_kw", pDischargeEl.value);

    params.set("eta_charge", etaCEl.value);
    params.set("eta_discharge", etaDEl.value);
  }

  function openMonthlyModal() {
    document.getElementById("monthlyModal").style.display = "flex";
  }
  function closeMonthlyModal() {
    document.getElementById("monthlyModal").style.display = "none";
  }

  function renderMonthlyCharts(yearSim) {
    if (!yearSim || !yearSim.monthly) {
      throw new Error("No yearly monthly data available. Click Refresh summary first.");
    }

    const m = yearSim.monthly;
    const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    const labels = m.month.map(s => {
      const mm = Number(String(s).split("-")[1]);  // "2024-03" -> 3
      return monthNames[mm - 1];
    });

    // Destroy existing charts
    if (chartMonthlyEnergy) chartMonthlyEnergy.destroy();
    if (chartMonthlyCost) chartMonthlyCost.destroy();

    // 1) Monthly energy balance (stacked)
    chartMonthlyEnergy = new Chart(document.getElementById("chartMonthlyEnergy"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Load (kWh)", data: m.load_kwh, stack: "kwh" },
          { label: "PV (kWh)", data: m.pv_kwh, stack: "kwh" },
          { label: "Import (kWh)", data: m.import_kwh, stack: "kwh2" },
          { label: "Export (kWh)", data: m.export_kwh, stack: "kwh2" },
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: true },
          y: { stacked: true }
        }
      }
    });

    // 2) Monthly costs/savings (bars)
    chartMonthlyCost = new Chart(document.getElementById("chartMonthlyCost"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Baseline cost (DKK)", data: m.baseline_cost_dkk },
          { label: "Cost with PV (DKK)", data: m.system_cost_dkk },
          { label: "Savings (DKK)", data: m.savings_dkk }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: { stacked: false },
          y: { stacked: false }
        }
      }
    });
  }

  function renderSimulationYear(data) {
    const s = data.summary;
    const year = data.inputs.year;

    function fmt(x, digits = 2) {
      if (x === null || x === undefined || Number.isNaN(Number(x))) return "—";
      return Number(x).toFixed(digits);
    }
    function pct(x) {
      if (x === null || x === undefined) return "—";
      return (Number(x) * 100).toFixed(1) + " %";
    }

    simYearEl.innerHTML = `
      <details class="section">
        <summary>
          Yearly simulation (${year})
          <span class="badge">${fmt(s.savings_dkk)} DKK</span>
        </summary>
        <div class="body">
          <details class="section" open>
            <summary>Totals</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Baseline cost</div>
                <div class="v">${fmt(s.baseline_cost_dkk)} DKK</div>

                <div class="k">Cost with PV</div>
                <div class="v">${fmt(s.system_cost_dkk)} DKK</div>

                <div class="k">Savings</div>
                <div class="v"><b>${fmt(s.savings_dkk)} DKK</b></div>

                <div class="k">Load</div>
                <div class="v">${fmt(s.load_kwh)} kWh</div>

                <div class="k">PV production</div>
                <div class="v">${fmt(s.pv_kwh)} kWh</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Key ratios</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Self-consumption</div>
                <div class="v">${pct(s.self_consumption_ratio)}</div>

                <div class="k">Self-sufficiency</div>
                <div class="v">${pct(s.self_sufficiency)}</div>
              </div>
            </div>
          </details>
        </div>
      </details>
    `;
  }


  function setSelected(lat, lon) {
    selected = {lat, lon};
    coord.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    statusEl.textContent = "Location set. Use Refresh summary / Show plots afterwards.";

    if (marker) {
      marker.setLatLng([lat, lon]);
    }
  }

  function tip(text) {
    return `<span class="qm" data-tip="${escapeAttr(text)}">?</span>`;
  }

  function renderSummary(data) {
    const s = data.inputs;

    const locationStr = `${data.location.lat.toFixed(5)}, ${data.location.lon.toFixed(5)}`;
    const settingsStr = `kWp=${Number(s.kwp).toFixed(2)}, PR=${Number(s.pr).toFixed(2)}, tilt=${Number(s.tilt).toFixed(0)}°, az=${Number(s.az).toFixed(0)}°`;

    const peakPoa = Math.round(data.peak_poa_wm2);
    const peakPower = Math.round(data.peak_power_w);
    const yearKwh = Math.round(data.energy_year_kwh_tmy);

    const html = `
      <details class="section">
        <summary>
          PV results
          <span class="badge">${yearKwh} kWh/yr</span>
        </summary>

        <div class="body">

          <details class="section" open>
            <summary>Energy results</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Year total (TMY/PVGIS)</div>
                <div class="v">${yearKwh} kWh (year ${escapeHtml(String(s.year))})</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Peak values</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Peak POA</div>
                <div class="v">${peakPoa} W/m²</div>

                <div class="k">Peak PV power</div>
                <div class="v">${peakPower} W</div>
              </div>
            </div>
          </details>

          <details class="section" open>
            <summary>Energy results</summary>
            <div class="body">
              <div class="row2">
                <div class="k">Year total (TMY/PVGIS)</div>
                <div class="v">${yearKwh} kWh (year ${escapeHtml(String(data.year))})</div>
              </div>
            </div>
          </details>

        </div>
      </details>
    `;


    summaryEl.innerHTML = html;

    // keep your plans rendering call:
    renderPlans(data.plan);
  }

  function applyLayerSwatches(layerControl, styleByDisplayName) {
    const root = layerControl.getContainer();

    // Add a title once
    if (!root.querySelector(".layers-title")) {
      const title = document.createElement("div");
      title.className = "layers-title";
      title.textContent = "Layers";
      root.insertBefore(title, root.firstChild);
    }

    // ---- 1) FIX BASE LAYERS: wrap text node into a span so spacing works ----
    const baseLabels = root.querySelectorAll(".leaflet-control-layers-base label");
    baseLabels.forEach(label => {
      const input = label.querySelector('input[type="radio"]');
      if (!input) return;

      // If already wrapped, do nothing
      if (label.querySelector("span.layer-name")) return;

      const name = label.textContent.trim(); // capture text BEFORE changing DOM

      const span = document.createElement("span");
      span.className = "layer-name";
      span.textContent = name;

      // Replace label contents with: [radio][span]
      label.replaceChildren(input, span);
    });

    // ---- 2) OVERLAYS: add swatches + ensure name span class ----
    const overlayLabels = root.querySelectorAll(".leaflet-control-layers-overlays label");
    overlayLabels.forEach(label => {
      const input = label.querySelector('input[type="checkbox"]');
      const span = label.querySelector("span"); // Leaflet creates span for overlays
      if (!input || !span) return;

      const name = span.textContent.trim();
      const st = styleByDisplayName[name];
      if (!st) return;

      span.classList.add("layer-name");

      let sw = label.querySelector(".layer-swatch");
      if (!sw) {
        sw = document.createElement("span");
        sw.className = "layer-swatch";
        label.appendChild(sw);
      }

      sw.style.borderColor = st.color || "#666";
      sw.style.background = st.fillColor || st.color || "#999";
      sw.style.opacity = (st.fillOpacity ?? 0.25);

      // Ensure order: input | name | swatch
      label.insertBefore(input, label.firstChild);
      label.insertBefore(span, input.nextSibling);
    });
  }

  function isUrl(s) {
    return typeof s === "string" && (s.startsWith("http://") || s.startsWith("https://"));
  }

  function niceLabel(key) {
    // Optional: rename keys to nicer labels
    const map = {
      plannavn: "Plan name",
      planid: "Plan ID",
      plantype: "Plan type",
      status: "Status",
      doklink: "Document",
      link: "Link",
      url: "URL",
      doklink: "Document"
    };
    return map[key] || key;
  }

  function isEmptyVal(v) {
    return v === null || v === undefined || String(v).trim() === "";
  }

  function renderDetailSection(title, items) {
    const rows = items
      .filter(it => !isEmptyVal(it.value))
      .map(it => `
        <div class="detailRow">
          <div class="detailLabel">${escapeHtml(it.label)}</div>
          <div class="detailValue">${escapeHtml(String(it.value))}</div>
        </div>
      `)
      .join("");

    if (!rows) return "";

    return `
      <div class="detailSection">
        <div class="detailTitle">${escapeHtml(title)}</div>
        <div class="detailBody">${rows}</div>
      </div>
    `;
  }

  function renderDetails(details) {
    if (!details || !Array.isArray(details) || details.length === 0) {
      return "<div class='small'>No extra details.</div>";
    }

    const d = details[0];

    const sol = renderDetailSection("Sol", [
      { label: "Side", value: d.sol_side },
      { label: "Paragraf", value: d.sol_paragraf },
      { label: "Kommentar", value: d.kommentar_sol },
    ]);

    const vind = renderDetailSection("Vind", [
      { label: "Side", value: d.vind_side },
      { label: "Paragraf", value: d.vind_paragraf },
      { label: "Kommentar", value: d.kommentar_vind },
    ]);

    const batteri = renderDetailSection("Batteri", [
      { label: "Side", value: d.batteri_side },
      { label: "Paragraf", value: d.batteri_paragraf },
      { label: "Kommentar", value: d.kommentar_batteri },
    ]);

    const tekniske = renderDetailSection("Tekniske anlæg", [
      { label: "Side", value: d.tekniske_anlaeg_side },
      { label: "Paragraf", value: d.tekniske_anlaeg_paragraf },
      { label: "Kommentar", value: d.kommentar_tekniske_anlaeg },
    ]);

    const andet = renderDetailSection("Andet relevant regulering", [
      { label: "Side", value: d.andet_side },
      { label: "Paragraf", value: d.andet_paragraf },
      { label: "Kommentar", value: d.kommentar_andet_regulering },
    ]);

    const kort = renderDetailSection("Kort kommentar", [
      { label: "Kommentar", value: d.kommentar_kort },
    ]);

    const html = [sol, vind, batteri, tekniske, andet, kort].filter(Boolean).join("");

    return html || "<div class='small'>No relevant fields found in details.</div>";
  }


  function renderPlans(plans) {
    if (!plansEl) return;

    if (!plans || plans.length === 0) {
      plansEl.innerHTML = "<div class='small'>No plans found at clicked location.</div>";
      return;
    }

    const parts = [];
    parts.push(`<div class="small"><b>Found:</b> ${plans.length}</div>`);

    plans.forEach((p, idx) => {
      const name = p.plannavn || p.plan_navn || p.navn || `Plan ${idx + 1}`;
      const id = p.planid ? String(p.planid) : "";
      const status = p.status ? String(p.status) : "";
      const det = p.details?.[0] || {};

      function warn(flag, label){
        return flag ? `<span class="warnPill">⚠ ${label}</span>` : "";
      }

      const warnings = [
        warn(det.sol_relevant, "Sol"),
        warn(det.vind_relevant, "Vind"),
        warn(det.batteri_relevant, "Batteri"),
        warn(det.tekniske_anlaeg_relevant, "Teknik"),
        warn(det.andet_relevant_regulering, "Andet"),
      ].join("");

      // Her kan der udføres visuelle ændringer for plan-interface på HTML
      parts.push(`
        <details class="planItem">
          <summary>
            ${escapeHtml(name)}
            ${id ? `<span class="pill">ID: ${escapeHtml(id)}</span>` : ""}
            ${warnings}
          </summary>
          <div class="planBody">
            <div class="kv">
              ${Object.entries(p).map(([k, v]) => {
                if (v === null || v === undefined || v === "") return "";
                const keyLabel = niceLabel(k);

                // ✅ Special rendering for details (array of objects)
                if (k === "details") {
                  return `<div style="grid-column: 1 / -1;">${renderDetails(v)}</div>`;
                }

                const valStr = String(v);

                if (isUrl(valStr)) {
                  return `<div class="k">${escapeHtml(keyLabel)}</div>
                          <div class="v"><a href="${escapeAttr(valStr)}" target="_blank" rel="noopener noreferrer">Open document</a></div>`;
                }

                return `<div class="k">${escapeHtml(keyLabel)}</div>
                        <div class="v">${escapeHtml(valStr)}</div>`;
              }).join("")}
            </div>
          </div>
        </details>
      `);
    });

    plansEl.innerHTML = parts.join("");
  }

  // Basic escaping to avoid breaking HTML if plan fields contain odd characters
  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }
  function escapeAttr(s) {
    // For href attributes
    return escapeHtml(s);
  }

  async function init() {
    const extraOverlays = {}; // name -> Leaflet layer
    const center = await getJSON("/api/center");

    // Map
    const map = L.map("map").setView([center.lat, center.lon], 10);

    // ----- Base layers -----

    // OpenStreetMap
    const osm = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        minZoom: 10,
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }
    );

    // Esri satellite
    const esriSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        minZoom: 10,
        maxZoom: 19,
        attribution: "Tiles © Esri"
      }
    );

    // Default layer shown when map loads
    osm.addTo(map);


    // Marker visible immediately (like original)
    marker = L.marker([center.lat, center.lon]).addTo(map);
    setSelected(center.lat, center.lon);

    // ----- Layers from backend config (/api/layers) -----
    const overlays = {};
    const styleByDisplayName = {};

    const layersResp = await getJSON("/api/layers");
    const layerMeta = layersResp.layers || [];

    let boundsLayer = null;

    for (const info of layerMeta) {
      const gj = await getJSON(`/api/layers/${encodeURIComponent(info.id)}`);

      const style = info.style || { color: "#666", weight: 2, fillOpacity: 0.10 };

      const gjLayer = L.geoJSON(gj, {
        style,
        onEachFeature: (feature, layer) => {
          layer.on("click", (e) => setSelected(e.latlng.lat, e.latlng.lng));
        }
      });

      // Swatches keyed by the displayed GUI name
      styleByDisplayName[info.name] = style;

      // Add to layer control only if allowed
      if (info.show_in_control) {
        overlays[info.name] = gjLayer;
      }

      // Add to map by default if enabled
      if (info.enabled_by_default) {
        gjLayer.addTo(map);
        if (!boundsLayer) boundsLayer = gjLayer;
      }
    }

    // Optional: fit to the first default-enabled layer (if it exists)
    if (boundsLayer && boundsLayer.getBounds && boundsLayer.getBounds().isValid()) {
      const b = boundsLayer.getBounds();
      map.fitBounds(b.pad(0.15));
      map.setMaxBounds(b.pad(0.25));
    }

    L.Control.geocoder({
      defaultMarkGeocode: false,
      placeholder: "Indtast adresse",
      collapsed: false
    })
    .on('markgeocode', function(e) {
      const latlng = e.geocode.center;

      setSelected(latlng.lat, latlng.lng);  // your existing function
      map.setView(latlng, 15);

      if (marker) marker.setLatLng(latlng);
    })
    .addTo(map);

    // Map click (works everywhere not caught by polygons)
    map.on("click", (e) => {
      setSelected(e.latlng.lat, e.latlng.lng);
    });

    // ----- Layer control (built from config-loaded overlays) -----
    const baseLayers = {
      "OpenStreetMap": osm,
      "Satellite (Esri)": esriSat
    };

    const layerControl = L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

    // Add swatches once (must happen AFTER control is added)
    setTimeout(() => applyLayerSwatches(layerControl, styleByDisplayName), 0);

    // Buttons
    document.getElementById("btnSummary").onclick = async () => {
      if (!selected) {
        statusEl.textContent = "Click map to set location first.";
        return;
      }

      statusEl.textContent = "Computing all results…";
      
      const params = new URLSearchParams({
        lat: selected.lat,
        lon: selected.lon,
        kwp: kwpEl.value,
        pr: prEl.value,
        tilt: tiltEl.value,
        az: azEl.value,
        annual_kwh: annualKwhEl.value,
      });

      addBatteryParams(params);

      // show some progress in the UI (optional but nice)
      if (typeof simYearEl !== "undefined" && simYearEl) simYearEl.innerHTML = "<div class='small'>Running yearly simulation…</div>";

      try {
        // 1) PV summary
        const summary = await getJSON(`/api/summary?${params.toString()}`);
        lastSummary = summary;
        renderSummary(summary);

        // 2) Day simulation (removed function)

        // 3) Year simulation
        const year = "2025";
        const yearParams = new URLSearchParams({
          lat: selected.lat,
          lon: selected.lon,
          kwp: kwpEl.value,
          pr: prEl.value,
          tilt: tiltEl.value,
          az: azEl.value,
          year: year,
          annual_kwh: annualKwhEl.value,
        });

        addBatteryParams(yearParams);

        lastYearSim = await getJSON(`/api/simulate_year?${yearParams.toString()}`);
        const yearSim = await getJSON(`/api/simulate_year?${yearParams.toString()}`);
        renderSimulationYear(yearSim);

        statusEl.textContent = "All results updated.";
      } catch (err) {
        statusEl.textContent = "Error while computing results.";
        console.error(err);

        // show errors in the boxes if present
        if (typeof simEl !== "undefined" && simEl) {
          simEl.innerHTML = "<pre class='small'>Error:\n" + escapeHtml(String(err)) + "</pre>";
        }
        if (typeof simYearEl !== "undefined" && simYearEl) {
          simYearEl.innerHTML = "<pre class='small'>Error:\n" + escapeHtml(String(err)) + "</pre>";
        }
      }
    };

      // Modal close button
    document.getElementById("btnMonthlyClose").onclick = closeMonthlyModal;

    // Click outside card closes modal
    document.getElementById("monthlyModal").onclick = (e) => {
      if (e.target.id === "monthlyModal") closeMonthlyModal();
    };

    // Monthly overview button
    document.getElementById("btnMonthly").onclick = () => {
      try {
        renderMonthlyCharts(lastYearSim);
        openMonthlyModal();
        statusEl.textContent = "Monthly overview opened.";
      } catch (err) {
        statusEl.textContent = String(err);
        console.error(err);
      }
    };

  }

  init().catch(err => {
    summaryEl.textContent = "Init error:\n" + err;
    statusEl.textContent = "Error during initialization. See details in output box.";
    console.error(err);
  });
</script>
</body>
</html>
